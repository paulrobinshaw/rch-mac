{"id":"bd-1nt","title":"M7: Conformance and regression test suite","description":"Milestone 7: Test suite validation.\n\nRequirements:\n- Classifier correctness tests\n- JobSpec determinism tests\n- Source bundle reproducibility tests\n- Artifact schema compliance tests\n- Protocol round-trip tests\n- State machine transition tests\n- Cache correctness tests\n\nRef: PLAN.md Conformance tests section","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-11T10:42:54.166752363Z","created_by":"ubuntu","updated_at":"2026-02-11T10:42:54.17830863Z","labels":["implementation","m7","milestone"]}
{"id":"bd-1rt","title":"M0: macOS worker SSH setup","description":"Milestone 0: Ensure macOS worker is reachable via SSH with appropriate tags.\n\nRequirements:\n- Mac mini accessible via SSH\n- Worker tagged with 'macos,xcode'\n- SSH key authentication configured\n- Known host fingerprint recorded\n\nRef: PLAN.md milestones section","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-11T10:42:25.863873255Z","created_by":"ubuntu","updated_at":"2026-02-11T10:42:58.271214306Z","labels":["m0","milestone"],"dependencies":[{"issue_id":"bd-1rt","depends_on_id":"bd-3mr","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"bd-1sy","title":"Manual integration of APR rounds 6-21","description":"## Context\nCobaltStream discovered that only rounds 1-5 have been integrated into PLAN.md/README.md.\nRounds 6-21 contain valuable spec refinement feedback that needs manual integration.\n\n## Scope\n- Review rounds 6-21 for high-value patches\n- Manually integrate changes into PLAN.md and README.md\n- Document integration decisions\n- Follows AGENTS.md guidelines (PLAN.md is normative)\n\n## Acceptance Criteria\n- [ ] Each round reviewed for integration candidates\n- [ ] High-value changes integrated into appropriate documents\n- [ ] Integration decisions documented\n- [ ] Git commits with clear messages\n\n## Related\n- Blocked by: Oracle failures preventing automated APR\n- Unblocks: Spec convergence toward 75% target","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T10:45:59.801499078Z","created_by":"ubuntu","updated_at":"2026-02-11T10:46:24.247529784Z","closed_at":"2026-02-11T10:46:24.24745776Z","close_reason":"Not needed - spec is already complete with 23 APR rounds integrated. Rounds 20-23 show 'clean pass' and 'spec confirmed ready for implementation'.","labels":["apr","spec"]}
{"id":"bd-26z","title":"M2: MVP remote execution with xcodebuild","description":"Milestone 2: Basic remote execution using xcodebuild backend.\n\nRequirements:\n- Source bundle creation and transfer\n- Worker harness protocol implementation\n- Job state machine (QUEUED→RUNNING→terminal)\n- Basic artifact collection\n- xcodebuild backend integration\n\nRef: PLAN.md Host↔Worker protocol section","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-11T10:42:36.523634646Z","created_by":"ubuntu","updated_at":"2026-02-11T10:42:58.474040752Z","labels":["implementation","m2","milestone"],"dependencies":[{"issue_id":"bd-26z","depends_on_id":"bd-1rt","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"bd-26z","depends_on_id":"bd-2wx","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"bd-2hg","title":"M3: XcodeBuildMCP backend integration","description":"Milestone 3: Switch to XcodeBuildMCP backend for richer diagnostics.\n\nRequirements:\n- XcodeBuildMCP backend implementation\n- Richer event streams\n- Multi-step orchestration support\n- Fallback to xcodebuild when MCP unavailable\n\nRef: PLAN.md Backends section","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-11T10:42:45.893157601Z","created_by":"ubuntu","updated_at":"2026-02-11T10:42:45.914480416Z","labels":["implementation","m3","milestone"]}
{"id":"bd-2o3","title":"Investigate APR consecutive failures","description":"The APR system stopped at round 22 due to consecutive_failures. Need to investigate:\n\n1. Check auto-logs for error details\n2. Review Oracle TDZ bug workaround status\n3. Determine if Oracle server needs restart\n4. Document root cause and resolution\n\nRef: docs/apr-operations.md for troubleshooting procedures","status":"in_progress","priority":1,"issue_type":"task","assignee":"EmeraldHeron","created_at":"2026-02-11T10:42:13.781339383Z","created_by":"ubuntu","updated_at":"2026-02-11T10:44:15.675874159Z","labels":["apr","blocker"],"comments":[{"id":1,"issue_id":"bd-2o3","author":"Paul Robinshaw","text":"## Investigation Findings (EmeraldHeron)\n\n**Root Cause Analysis:**\n- Oracle on Mac mini (100.122.100.99:9333) is failing with exit code 1\n- Pre-flight checks pass (Oracle available 0.8.5) but actual calls fail\n- Each attempt fails quickly (~47s total for 3 attempts with retries)\n- Pattern suggests CDP/browser state issue rather than timeout\n\n**Evidence from log (run_20260208_074324.log):**\n```\n⚠ Attempt 1/3 failed (exit code: 1)\n⚠ Attempt 2/3 failed (exit code: 1)  \n✗ All 3 attempts failed\n✗ Oracle failed after 0:46 (exit code: 1)\n```\n\n**Likely Causes:**\n1. Stale Oracle sessions (requires `oracle session --clear --all`)\n2. CDP/Chrome browser state corruption on Mac mini\n3. Oracle TDZ bug (known issue #85, needs manual patch or Oracle \u003e= 0.8.6)\n\n**Required Remediation (per docs/apr-operations.md):**\n```bash\n# Full cleanup and restart one-liner:\nssh -i ~/.ssh/acfs_ed25519 ubuntu@161.97.185.227 'pkill -f apr_auto 2\u003e/dev/null; sleep 1; rm -f /data/projects/rch-mac/.apr/.locks/*.lock 2\u003e/dev/null; oracle session --clear --all 2\u003e\u00261; tmux send-keys -t rch-mac \"cd /data/projects/rch-mac \u0026\u0026 python3 apr_auto.py\" Enter'\n\n# Verify Oracle on Mac mini:\nssh -o IdentitiesOnly=yes -i ~/.ssh/acfs_ed25519 paul@100.122.100.99 'pgrep -f \"oracle serve\"'\n```\n\n**Status:** Requires SSH access to VPS and Mac mini to remediate","created_at":"2026-02-11T10:43:48Z"},{"id":2,"issue_id":"bd-2o3","author":"Paul Robinshaw","text":"## Blocker: No SSH Access\n\n**Status:** Cannot remediate from this environment\n\nThe required SSH key `~/.ssh/acfs_ed25519` is not available. VPS is reachable (ping OK) but authentication fails.\n\n**Required action:**\nSomeone with SSH access to the infrastructure must run the cleanup procedure documented in docs/apr-operations.md:\n\n```bash\n# From a machine with acfs_ed25519 key:\nssh -i ~/.ssh/acfs_ed25519 ubuntu@161.97.185.227 'pkill -f apr_auto 2\u003e/dev/null; sleep 1; rm -f /data/projects/rch-mac/.apr/.locks/*.lock 2\u003e/dev/null; oracle session --clear --all 2\u003e\u00261; tmux send-keys -t rch-mac \"cd /data/projects/rch-mac \u0026\u0026 python3 apr_auto.py\" Enter'\n```\n\n**Next steps:**\n1. User with SSH access applies the fix\n2. Verify Oracle restarts successfully\n3. Monitor for successful round completion\n\n—EmeraldHeron","created_at":"2026-02-11T10:44:15Z"}]}
{"id":"bd-2os","title":"M5: Remote caching (DerivedData, SPM)","description":"Milestone 5: Performance optimization via caching.\n\nRequirements:\n- DerivedData cache modes: off | per_job | shared\n- SPM cache mode: off | shared\n- Cache keying by toolchain identity\n- Locking + isolation for shared caches\n- Eviction/GC policies\n\nRef: PLAN.md Caching section","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-11T10:42:46.036818292Z","created_by":"ubuntu","updated_at":"2026-02-11T10:42:46.050015369Z","labels":["implementation","m5","milestone"]}
{"id":"bd-2wx","title":"M1: Implement Classifier for Xcode detection","description":"Milestone 1: Classifier detects safe Xcode build/test invocations.\n\nRequirements:\n- Deny-by-default gate\n- Allowed: xcodebuild build, xcodebuild test\n- Denied: archive, exportArchive, signing flows\n- Minimal safe flag subset\n- Emit machine-readable rejection reasons\n\nRef: PLAN.md Classifier section","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-11T10:42:31.230937456Z","created_by":"ubuntu","updated_at":"2026-02-11T10:42:58.343463667Z","labels":["implementation","m1","milestone"],"dependencies":[{"issue_id":"bd-2wx","depends_on_id":"bd-3mr","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"bd-35i","title":"M6: Worker capability handshake + selection","description":"Milestone 6: Deterministic worker selection.\n\nRequirements:\n- Worker capabilities.json reporting\n- Selection algorithm (tags → constraints → priority → stable name)\n- worker_selection.json artifact\n- Toolchain resolution (Xcode version matching)\n\nRef: PLAN.md Worker selection section","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-11T10:42:54.096538649Z","created_by":"ubuntu","updated_at":"2026-02-11T10:42:54.112697331Z","labels":["implementation","m6","milestone"]}
{"id":"bd-3mr","title":"Resume APR rounds to reach 75% stability","description":"After fixing the consecutive failure issue, resume APR automated rounds.\n\nTarget: 75% stability score before moving to implementation\nCurrent: ~20% estimated convergence (21 rounds completed)\nEstimated: ~4 more rounds needed\n\nSteps:\n1. Verify Oracle server is healthy\n2. Reset apr_auto.py failure counter\n3. Restart automated APR loop\n4. Monitor for convergence\n\nBlocked by: APR failure investigation","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T10:42:20.513302956Z","created_by":"ubuntu","updated_at":"2026-02-11T10:42:58.211324216Z","labels":["apr"],"dependencies":[{"issue_id":"bd-3mr","depends_on_id":"bd-2o3","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"bd-9qi","title":"M4: Emit summary, attestation, manifest artifacts","description":"Milestone 4: Complete artifact emission.\n\nRequired artifacts:\n- summary.json (status, failure_kind, exit_code)\n- attestation.json (job_id, job_key, worker identity)\n- manifest.json (path, size, sha256 per artifact)\n\nRef: PLAN.md Artifact attestation section","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-11T10:42:45.961720297Z","created_by":"ubuntu","updated_at":"2026-02-11T10:42:45.972483207Z","labels":["implementation","m4","milestone"]}
{"id":"rch-mac-0bw","title":"M6: Advanced Worker Selection and Run Management (Post-MVP)","description":"Milestone 6 (post-MVP): Adaptive worker selection, worker leases, run resumption after host restart, concurrent host runs, and advanced toolchain resolution.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:43.885389271Z","created_by":"root","updated_at":"2026-02-10T22:21:43.885389271Z","dependencies":[{"issue_id":"rch-mac-0bw","depends_on_id":"rch-mac-y6s","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0bw.1","title":"Adaptive worker selection mode","description":"Implement adaptive worker selection mode (worker_selection.mode=adaptive). Dynamic metrics (current load, free disk) may be used as tie-breakers. Must record exact metric values in worker_selection.json. Default remains deterministic.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:44.566963723Z","created_by":"root","updated_at":"2026-02-10T22:21:44.566963723Z","dependencies":[{"issue_id":"rch-mac-0bw.1","depends_on_id":"rch-mac-0bw","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0bw.2","title":"Worker leases (reserve/release)","description":"If worker advertises feature lease: host calls reserve once per run before submitting, includes lease_id on each submit, renews if expiring, calls release when done. release must be idempotent (unknown/expired lease → ok: true). Lease TTL should be \u003e= connect_timeout + overall_seconds. If submit fails with LEASE_EXPIRED, attempt single reserve + re-submit before failing. run_state.json records lease_renewed if re-reservation occurs. Capacity: reserve fails with WORKER_BUSY + retry_after_seconds when at capacity. Lease-based backstop: worker auto-cancels RUNNING jobs whose lease expires without release (safety net for host crashes).","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:45.311275715Z","created_by":"root","updated_at":"2026-02-10T22:21:45.311275715Z","dependencies":[{"issue_id":"rch-mac-0bw.2","depends_on_id":"rch-mac-0bw","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0bw.3","title":"Run resumption after host restart","description":"On host restart: 1) Read run_plan.json to recover step list and job_ids. 2) For each step, check job_index.json existence (commit marker). If present: treat as COMPLETE. If absent: query worker via status. If RUNNING: resume tailing. If COMPLETE: fetch artifacts. If unknown/unreachable: re-submit with same job_id. 3) Do not skip failed jobs on resumption unless run is CANCELLED. 4) Record resumed_at in run_state.json. 5) Re-probe worker, verify protocol_version from run_plan.json still in worker range (PROTOCOL_DRIFT if not). Verify worker still has required Xcode build (TOOLCHAIN_CHANGED if not). 6) If original worker needs lease and cant re-acquire (BUSY/unreachable), fail. Must NOT switch workers mid-run (job_key_inputs bound to original worker toolchain).","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:46.115717298Z","created_by":"root","updated_at":"2026-02-10T22:21:46.115717298Z","dependencies":[{"issue_id":"rch-mac-0bw.3","depends_on_id":"rch-mac-0bw","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0bw.4","title":"Concurrent host runs","description":"Multiple runs may execute concurrently on same host. Each uses unique run_id (no artifact directory collision). Must not hold filesystem locks on shared resources across runs. If worker returns WORKER_BUSY, respect retry_after_seconds, no busy-loop, bounded retry with exponential backoff (max 3 retries). Host-side artifact GC must acquire lock before scanning/deleting, skip RUNNING run artifacts.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:46.859843374Z","created_by":"root","updated_at":"2026-02-10T22:21:46.859843374Z","dependencies":[{"issue_id":"rch-mac-0bw.4","depends_on_id":"rch-mac-0bw","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0bw.5","title":"M6 tests: selection, leases, resumption","description":"Tests for M6 worker selection, leases, and run resumption.\n\n**Worker selection tests:**\n\n1. **Deterministic mode — stable ordering:**\n   - 3 workers: A (priority=1), B (priority=2), C (priority=1)\n   - Expected: A selected (priority 1, then alphabetical A \u003c C)\n   - Run 10 times → same worker every time\n   - Pass: always selects A, worker_selection.json records candidate_count=3\n\n2. **Adaptive mode — metric tie-breaking:**\n   - 2 workers: A and B, same priority, A has higher load\n   - Expected: B selected (lower load as tie-breaker)\n   - Verify: worker_selection.json records `selection_mode=adaptive` and metric values used\n   - Pass: B selected, metrics recorded\n\n3. **Probe failure handling:**\n   - 3 workers: A unreachable, B and C reachable\n   - Expected: A excluded, worker_selection.json has `probe_failures[{worker: \"A\", probe_error: \"...\", probe_duration_ms: ...}]`\n   - Pass: A not selected, probe failure recorded\n\n4. **All probes fail:**\n   - All workers unreachable\n   - Expected: `failure_kind=SSH`, `human_summary` lists unreachable workers\n   - Pass: clear error naming all workers\n\n5. **Stale snapshot rejection:**\n   - Cached capabilities older than `probe_ttl_seconds`, fresh probe fails\n   - Expected: host does NOT fall back to stale snapshot, worker excluded\n   - Pass: worker not selected despite having cached data\n\n6. **worker_selection.json completeness:**\n   - Verify all normative fields: `schema_version`, `schema_id`, `created_at`, `run_id`, `negotiated_protocol_version`, `worker_protocol_range`, `selected_worker`, `selected_worker_host`, `selection_mode`, `candidate_count`, `probe_failures`, `snapshot_age_seconds`, `snapshot_source`\n   - Pass: all fields present with correct types\n\n**Lease tests:**\n\n7. **Lease lifecycle (happy path):**\n   - reserve → get lease_id → submit with lease_id → release\n   - Pass: all ops succeed, release is idempotent (call twice → both ok)\n\n8. **Lease expiry and re-reserve:**\n   - reserve → let lease expire → submit fails with LEASE_EXPIRED → re-reserve → submit succeeds\n   - Verify: `run_state.json` records `lease_renewed: true`\n   - Pass: single re-reserve cycle works, recorded in state\n\n9. **Reserve when busy:**\n   - Worker at capacity → reserve fails with `failure_kind=WORKER_BUSY`, `retry_after_seconds` present\n   - Pass: exact failure kind, retry_after present and positive\n\n10. **Release idempotency:**\n    - Release unknown/expired lease_id → `ok: true` (no error)\n    - Pass: no error on double-release or expired release\n\n**Run resumption tests:**\n\n11. **Resume after host crash (job completed on worker):**\n    - Persist run_plan.json with 2 steps, first step has job_index.json (complete), second doesn't\n    - Worker reports second job as COMPLETE via status query\n    - Expected: host fetches second job's artifacts, completes run\n    - Verify: `run_state.json` has `resumed_at` field\n    - Pass: run completes without re-execution\n\n12. **Resume — job still RUNNING on worker:**\n    - run_plan.json persisted, no job_index.json for current step\n    - Worker reports job RUNNING → host resumes tailing\n    - Pass: host successfully tails and completes\n\n13. **Resume — worker unknown job_id:**\n    - Worker reports unknown job_id → host re-submits with same job_id\n    - Pass: job re-executes, idempotency preserved\n\n14. **Protocol drift detection on resume:**\n    - run_plan.json has `protocol_version=1`, worker now reports [2,3]\n    - Expected: `failure_kind=WORKER_INCOMPATIBLE`, `failure_subkind=PROTOCOL_DRIFT`\n    - Pass: clear error, no execution\n\n15. **Toolchain change detection on resume:**\n    - run_plan.json references `xcode_build=16C5032a`, worker no longer has it\n    - Expected: `failure_kind=WORKER_INCOMPATIBLE`, `failure_subkind=TOOLCHAIN_CHANGED`\n    - Pass: clear error\n\n16. **No silent worker switch:**\n    - Original worker unreachable on resume\n    - Expected: fail (MUST NOT switch to different worker mid-run, job_key_inputs bound to original toolchain)\n    - Pass: error, not silent fallback\n\n**Concurrent run tests:**\n\n17. **Two concurrent runs — no interference:**\n    - Start two runs with different run_ids simultaneously\n    - Expected: separate artifact directories, separate run_state.json files\n    - Pass: both complete correctly, no file collisions\n\n18. **Artifact GC skips RUNNING runs:**\n    - Run in progress, trigger host artifact GC\n    - Expected: RUNNING run's artifacts NOT deleted\n    - Pass: GC scans run_state.json, skips RUNNING\n\n**Pass/fail:** Each test has explicit expected state/artifacts. Uses mock worker with controllable state. Tests run without live worker.\n\n**Logging:** Host MUST log at INFO: worker selected (name, mode), lease acquired/released/renewed, run resumed. At WARN: probe failures, lease expiry, protocol drift. Tests verify selection and resumption log entries.\n","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:47.673583991Z","created_by":"root","updated_at":"2026-02-11T07:21:20.792553032Z","dependencies":[{"issue_id":"rch-mac-0bw.5","depends_on_id":"rch-mac-0bw","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-0bw.5","depends_on_id":"rch-mac-0bw.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-0bw.5","depends_on_id":"rch-mac-0bw.2","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-0bw.5","depends_on_id":"rch-mac-0bw.3","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-0bw.5","depends_on_id":"rch-mac-0bw.4","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0uz","title":"M5: Caching and Performance (Post-MVP)","description":"Milestone 5 (post-MVP): Implement caching for build performance — DerivedData caching, SPM dependency caching, result caching, and metrics collection. Also host-side artifact retention/GC.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:38.79168302Z","created_by":"root","updated_at":"2026-02-10T22:21:38.79168302Z","dependencies":[{"issue_id":"rch-mac-0uz","depends_on_id":"rch-mac-y6s","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0uz.1","title":"DerivedData caching (off/per_job/shared)","description":"Implement DerivedData cache modes: off (no caching, clean build every time), per_job (DerivedData dir derived from job_key, reusable for same inputs), shared (shared DerivedData with toolchain-keyed directories and locking). per_job must write under directory derived from job_key. shared must use lock to prevent concurrent writers, lock must have timeout and emit diagnostics on contention. Cache directories must be additionally keyed by toolchain identity (at minimum Xcode build number + macOS major version) to prevent cross-toolchain corruption. Directory layout: caches/\u003cnamespace\u003e/derived_data/shared/\u003ctoolchain_key\u003e/... or caches/\u003cnamespace\u003e/derived_data/per_job/\u003cjob_key\u003e/...","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:39.483456108Z","created_by":"root","updated_at":"2026-02-10T22:21:39.483456108Z","dependencies":[{"issue_id":"rch-mac-0uz.1","depends_on_id":"rch-mac-0uz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0uz.2","title":"SPM dependency caching (off/shared)","description":"SPM cache modes: off (re-resolve every time), shared (keyed by resolved Package.resolved + toolchain identity). Directory: caches/\u003cnamespace\u003e/spm/\u003ctoolchain_key\u003e/... Cache namespace from repo config (cache.namespace, must be filesystem-safe: ^[A-Za-z0-9][A-Za-z0-9._-]{0,63}$, no /, \\, whitespace, ..).","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:40.212049953Z","created_by":"root","updated_at":"2026-02-10T22:21:40.212049953Z","dependencies":[{"issue_id":"rch-mac-0uz.2","depends_on_id":"rch-mac-0uz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0uz.3","title":"Result cache (keyed by job_key)","description":"Optional result cache on worker keyed by job_key. If present and complete, a submit may be satisfied by materializing artifacts from cached result without re-execution. Must rewrite run_id, job_id, created_at, job_key in all artifacts. Must record cached_from_job_id in summary.json. Must emit correct attestation.json for new job_id. Profile-aware: cached artifact_profile must be \u003e= requested profile, otherwise re-execute. Each cached entry records artifact_profile it satisfies.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:40.879404765Z","created_by":"root","updated_at":"2026-02-10T22:21:40.879404765Z","dependencies":[{"issue_id":"rch-mac-0uz.3","depends_on_id":"rch-mac-0uz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0uz.4","title":"Metrics collection (metrics.json)","description":"Emit metrics.json per job: schema_version, schema_id (rch-xcode/metrics@1), run_id, job_id, job_key, created_at, timings {bundle_ms, upload_ms, queue_ms, execute_ms, fetch_ms, total_ms}, cache {derived_data_hit, spm_hit, result_cache_hit}, cache_paths (resolved dirs used), sizes {source_bundle_bytes, artifact_bytes, xcresult_bytes}, cache_key_components (job_key, xcode_build, etc.).","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:41.650034152Z","created_by":"root","updated_at":"2026-02-10T22:21:41.650034152Z","dependencies":[{"issue_id":"rch-mac-0uz.4","depends_on_id":"rch-mac-0uz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0uz.5","title":"Cache eviction and garbage collection","description":"Worker-side cache eviction and garbage collection. Worker must implement at least one eviction strategy: size-based (keep under N GB) or age-based (delete items unused for N days). Eviction MUST NOT delete caches currently locked/in-use. Bundle GC MUST NOT remove bundles referenced by RUNNING jobs. Bundle GC policy MAY align with cache eviction policy. Record eviction events in worker logs. Note: host-side artifact retention is handled separately by rch-mac-0uz.7.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:42.445681748Z","created_by":"root","updated_at":"2026-02-11T07:14:05.369940104Z","dependencies":[{"issue_id":"rch-mac-0uz.5","depends_on_id":"rch-mac-0uz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0uz.6","title":"M5 tests: caching correctness","description":"Tests for M5 caching correctness. All cache tests use controlled fixtures to verify determinism.\n\n**Test cases:**\n\n1. **Result cache hit produces identical artifacts:**\n   - Run job with job_key=K1, complete successfully, cache result\n   - Submit new job_id with same job_key=K1\n   - Expected: worker materializes from cache, summary.json has `cached_from_job_id` set to original job_id\n   - Verify: all artifact content matches original (except run_id, job_id, created_at which are rewritten)\n   - Pass: cached artifacts schema-valid, content matches, `cached_from_job_id` present\n\n2. **Result cache profile-aware reuse:**\n   - Cache entry has `artifact_profile=minimal`\n   - New submit requests `artifact_profile=rich`\n   - Expected: cache miss, worker executes fresh (cached minimal cannot satisfy rich)\n   - Pass: fresh execution produces rich artifacts, no `cached_from_job_id`\n\n3. **DerivedData per_job isolation:**\n   - Two concurrent jobs with different job_keys\n   - Expected: each uses separate DerivedData directory derived from job_key\n   - Pass: no shared state, directories are `caches/\u003cnamespace\u003e/derived_data/per_job/\u003cjob_key\u003e/`\n\n4. **Shared DerivedData locking:**\n   - Two concurrent jobs configured for shared DerivedData\n   - Expected: lock acquired before writing, second job waits or retries\n   - Verify: lock has timeout, diagnostic logged on contention\n   - Pass: no corruption, both jobs complete, contention logged if it occurs\n\n5. **SPM cache keying:**\n   - Same Package.resolved + same toolchain → cache hit\n   - Same Package.resolved + different toolchain (different xcode_build) → cache miss\n   - Pass: cache directory includes toolchain_key component\n\n6. **Cache namespace validation:**\n   - Valid: `my-project`, `Foo.Bar_123` → accepted (regex `^[A-Za-z0-9][A-Za-z0-9._-]{0,63}$`)\n   - Invalid: `/etc/passwd`, `..`, empty, contains whitespace → rejected\n   - Pass: valid accepted, invalid produces diagnostic error\n\n7. **Cache eviction respects locks:**\n   - Job is running with shared cache locked\n   - GC triggered → MUST skip locked cache entries\n   - Pass: no deletion of in-use cache, GC logs skipped entries\n\n8. **Bundle GC does not remove bundles for RUNNING jobs:**\n   - Job is RUNNING, references source_sha256=S1\n   - Bundle GC runs → S1 NOT deleted\n   - Pass: has_source(S1) still returns true after GC\n\n9. **metrics.json accuracy:**\n   - Verify `timings` object has: `bundle_ms`, `upload_ms`, `queue_ms`, `execute_ms`, `fetch_ms`, `total_ms` — all ≥ 0\n   - Verify `cache` object: `derived_data_hit`, `spm_hit`, `result_cache_hit` are booleans\n   - Verify `sizes` object: `source_bundle_bytes`, `artifact_bytes` are ints ≥ 0\n   - Verify `cache_key_components` records concrete job_key, xcode_build, etc.\n   - Verify `cache_paths` records resolved directory paths\n   - Pass: all fields present with correct types, timings sum roughly to total_ms\n\n10. **Eviction policy enforcement:**\n    - Configure age-based eviction (max_age=0 for test), fill cache\n    - Run eviction → all eligible entries removed\n    - Pass: cache size reduced, only non-locked entries removed\n\n**Pass/fail:** Each test uses controlled mock or fixture environment. Cache correctness verified by comparing cached vs fresh artifact content byte-for-byte (excluding rewritten fields).\n\n**Logging:** Cache subsystem MUST log at INFO: cache hit/miss per job. At DEBUG: cache key computation details, resolved paths. At WARN: lock contention, eviction of large entries. Tests verify hit/miss logged for result cache scenarios.\n","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:43.119031714Z","created_by":"root","updated_at":"2026-02-11T07:20:48.822516585Z","dependencies":[{"issue_id":"rch-mac-0uz.6","depends_on_id":"rch-mac-0uz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-0uz.6","depends_on_id":"rch-mac-0uz.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-0uz.6","depends_on_id":"rch-mac-0uz.2","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-0uz.6","depends_on_id":"rch-mac-0uz.3","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-0uz.6","depends_on_id":"rch-mac-0uz.5","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-0uz.7","title":"Host artifact retention and GC (rch xcode gc)","description":"Implement host-side artifact retention to bound disk usage under the local artifact root. Support age-based and/or count-based limits (e.g. keep last N runs or last N days). MUST NOT delete artifacts for RUNNING runs (check run_state.json). Optional CLI: rch xcode gc for manual garbage collection. Log when artifacts are evicted and record the policy in effective_config.json. Acquire filesystem lock before scanning/deleting, skip artifacts belonging to any RUNNING run.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-11T07:10:45.079951381Z","created_by":"root","updated_at":"2026-02-11T07:10:45.079951381Z","dependencies":[{"issue_id":"rch-mac-0uz.7","depends_on_id":"rch-mac-0uz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-666","title":"M1.5: Mock Worker and Protocol Conformance","description":"Milestone 1.5: Implement a mock worker that supports all RPC operations for host-side integration testing. The mock worker validates request/response schemas and exercises host logic deterministically without requiring a real macOS worker. This is critical for CI and development velocity. Operations: probe, submit, status, tail, cancel, has_source, upload_source. The mock worker must follow the exact same JSON RPC envelope and protocol version negotiation as the real worker.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:07.535359937Z","created_by":"root","updated_at":"2026-02-11T14:06:06.272806437Z","closed_at":"2026-02-11T14:06:06.272742458Z","close_reason":"done"}
{"id":"rch-mac-666.1","title":"Mock worker implementation (all RPC ops)","description":"Implement a mock worker binary/library that handles all RPC operations defined in the protocol.\n\n## Operations\n- **probe**: return configurable capabilities (Xcode versions, runtimes, capacity, protocol range, features).\n- **reserve**: accept lease request, return lease_id with configurable TTL. Track active leases. Return BUSY when at capacity.\n- **release**: release lease by lease_id. Idempotent: unknown/expired lease returns ok.\n- **submit**: accept job.json, validate job_key matches SHA-256(JCS(job_key_inputs)), validate source_sha256 present. Store job, transition through QUEUED→RUNNING→SUCCEEDED/FAILED states on configurable schedule.\n- **status**: return current job state and pointers to logs/artifacts.\n- **tail**: return configurable log chunks with cursor-based pagination. Support next_cursor=null for completion.\n- **cancel**: transition job to CANCEL_REQUESTED then CANCELLED.\n- **fetch**: return job artifacts as binary-framed response (JSON header + tar stream). Return ARTIFACTS_GONE if artifacts deleted.\n- **has_source**: check in-memory/on-disk source store, return {exists: bool}.\n- **upload_source**: accept binary-framed upload, verify content_sha256. Atomic by source_sha256.\n\n## Protocol enforcement\n- Idempotency by job_id: same job_id+same job_key → return existing; different job_key → reject.\n- SOURCE_MISSING when source not present on submit.\n- protocol_version: 0 accepted only for probe; rejected for all other ops with UNSUPPORTED_PROTOCOL.\n- Protocol version negotiation within declared [protocol_min, protocol_max] range.\n\n## Failure injection\nSupport configurable failure injection for testing error paths:\n- Return specific error codes (BUSY, LEASE_EXPIRED, SOURCE_MISSING, etc.)\n- Configurable delays per operation\n- Configurable BUSY responses with retry_after_seconds\n- Simulate partial/crashed states (orphaned job dirs without job_index.json)\n\n## Deployment modes\n- Standalone binary: invoked via SSH like real worker (for integration tests)\n- In-process library: direct function calls (for unit tests)\n","acceptance_criteria":"- Mock worker handles all RPC ops: probe, reserve, release, submit, status, tail, cancel, fetch, has_source, upload_source\n- probe returns configurable capabilities\n- submit validates job_key == SHA-256(JCS(job_key_inputs))\n- job_id idempotency enforced: same job_id+same job_key → return existing; different job_key → reject\n- SOURCE_MISSING returned when source not present\n- Binary framing for upload_source: verify content_sha256\n- Binary framing for fetch: return artifact tar with manifest\n- Configurable failure injection (errors, delays, BUSY)\n- Usable as standalone binary AND in-process library\n- Protocol version negotiation: probe at v0, reject v0 for non-probe ops","notes":"## Testability design (critical — this is the test infrastructure)\n\n### In-process library mode (MUST)\nThe mock worker MUST be usable as an in-process library with a direct function call interface:\n- `MockWorker.handleRequest(request: JSON) → response: JSON`\n- `MockWorker.handleFramedRequest(header: JSON, stream: bytes) → response`\nThis enables unit testing of the host RPC client (axz.8) without SSH or subprocesses.\n\n### Configurable state machine\n- `MockWorker.setJobProgression(job_id, states: [QUEUED, RUNNING, SUCCEEDED])` — control how jobs transition\n- `MockWorker.holdJobInState(job_id, state)` — keep a job in a state until explicitly released\n- `MockWorker.releaseJob(job_id)` — advance to next state\n\n### Failure injection API\n- `MockWorker.injectError(op, errorCode, options?)` — next call to `op` returns the specified error\n- `MockWorker.injectDelay(op, ms)` — add latency to operation\n- `MockWorker.setCapacity(maxJobs)` — control BUSY responses\n- `MockWorker.evictSource(sha256)` — simulate GC eviction for TOCTOU tests\n- `MockWorker.deleteArtifacts(job_id)` — simulate ARTIFACTS_GONE\n\n### Deterministic behavior\nAll mock behavior MUST be deterministic given the same configuration. No random delays or jitter in mock mode. This ensures test reproducibility.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:08.351536315Z","created_by":"root","updated_at":"2026-02-11T14:05:09.724494676Z","closed_at":"2026-02-11T14:05:09.72438372Z","close_reason":"done","dependencies":[{"issue_id":"rch-mac-666.1","depends_on_id":"rch-mac-666","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-666.1","depends_on_id":"rch-mac-sai.5","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-666.2","title":"Protocol version negotiation tests","description":"Test protocol version bootstrap and negotiation against the mock worker.\n\n**Test cases with expected outcomes:**\n\n1. **Probe with protocol_version=0 (sentinel):**\n   - Input: `{protocol_version: 0, op: \"probe\", request_id: \"r1\", payload: {}}`\n   - Expected: `ok: true`, response includes `protocol_min`, `protocol_max`, `features[]`, response echoes `protocol_version: 0`\n   - Pass: all fields present, types correct\n\n2. **Non-probe op with protocol_version=0:**\n   - Input: `{protocol_version: 0, op: \"submit\", request_id: \"r2\", payload: {...}}`\n   - Expected: `ok: false`, `error.code: \"UNSUPPORTED_PROTOCOL\"`\n   - Test for each op: submit, status, tail, cancel, fetch, has_source, upload_source\n\n3. **Version selection — happy path:**\n   - Host supports [1,3], worker reports [2,4] → selected version MUST be 3 (max of intersection)\n   - Host supports [1,2], worker reports [1,2] → selected version MUST be 2\n   - Verify all subsequent requests use the selected version\n\n4. **Version selection — no intersection:**\n   - Host supports [1,2], worker reports [3,4] → host MUST fail with `failure_kind=WORKER_INCOMPATIBLE`\n   - Verify error message includes the ranges\n\n5. **Feature negotiation:**\n   - Host requires feature `tail`, worker advertises `[tail, events]` → proceed\n   - Host requires feature `tail`, worker advertises `[events]` → fail with `failure_kind=WORKER_INCOMPATIBLE`, `failure_subkind=FEATURE_MISSING`\n   - Verify error message names the missing feature\n\n6. **Edge cases:**\n   - Worker reports `protocol_min \u003e protocol_max` → host should reject (invalid range)\n   - Worker probe response missing required fields → host fails gracefully with diagnostic\n\n**Pass/fail:** Each test case has explicit expected response fields. Test fails on any field mismatch. All tests use mock worker (no live worker needed).\n\n**Logging:** Host MUST log at INFO: negotiated protocol version and selected features. At DEBUG: full probe response. Tests verify log contains negotiated version number.\n","status":"closed","priority":1,"issue_type":"task","assignee":"Paul Robinshaw","created_at":"2026-02-10T22:21:09.050596072Z","created_by":"root","updated_at":"2026-02-11T11:06:09.48643249Z","closed_at":"2026-02-11T11:06:09.48643249Z","close_reason":"22 protocol version negotiation tests covering all test cases from bead spec","dependencies":[{"issue_id":"rch-mac-666.2","depends_on_id":"rch-mac-666","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-666.2","depends_on_id":"rch-mac-666.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-666.3","title":"RPC envelope validation tests","description":"Test JSON RPC envelope structure for all operations against the mock worker.\n\n**Test cases:**\n\n1. **Valid request structure:**\n   - Input: `{protocol_version: 1, op: \"status\", request_id: \"r1\", payload: {job_id: \"...\"}}`\n   - Expected: response has `protocol_version: 1`, `request_id: \"r1\"`, `ok: true`, `payload: {...}`\n   - Pass: all envelope fields present and match\n\n2. **Request with missing required fields (one test per missing field):**\n   - Missing `protocol_version` → `error.code: \"INVALID_REQUEST\"`, message mentions \"protocol_version\"\n   - Missing `op` → `error.code: \"INVALID_REQUEST\"`, message mentions \"op\"\n   - Missing `request_id` → `error.code: \"INVALID_REQUEST\"`, message mentions \"request_id\"\n   - Missing `payload` → `error.code: \"INVALID_REQUEST\"`, message mentions \"payload\"\n\n3. **Wrong types:**\n   - `protocol_version: \"1\"` (string instead of int) → `INVALID_REQUEST`\n   - `op: 123` (int instead of string) → `INVALID_REQUEST`\n\n4. **Unknown op:**\n   - `op: \"destroy\"` → `INVALID_REQUEST`, message mentions unknown operation\n\n5. **Error response structure:**\n   - Trigger any error, verify response has: `ok: false`, `error.code` (string), `error.message` (string)\n   - Verify `error.message` is single-line (no literal newlines)\n   - Verify `error.message` does not contain file system paths outside job dir, stack traces, or secrets\n   - Verify `error.data` is object or absent (never string)\n\n6. **Error code registry coverage:**\n   - For each documented error code (INVALID_REQUEST, UNSUPPORTED_PROTOCOL, FEATURE_MISSING, BUSY, LEASE_EXPIRED, SOURCE_MISSING, ARTIFACTS_GONE, PAYLOAD_TOO_LARGE), construct a scenario that triggers it and verify the exact code string\n   - BUSY response MUST include `retry_after_seconds` in error.data\n\n7. **request_id echo:**\n   - Send request_id with special chars (UUID, emoji, max-length string)\n   - Response MUST echo exact same request_id\n\n8. **Extra fields in request:**\n   - Request with unknown extra field `{..., \"extra_field\": true}` → worker MUST NOT reject (forward compatibility)\n\n**Pass/fail:** Each test checks exact field values/types. Failures report expected vs actual. All tests use mock worker.\n\n**Logging:** Worker MUST log at DEBUG: received op + request_id. Tests verify log contains op name for each request.\n","status":"closed","priority":1,"issue_type":"task","assignee":"Paul Robinshaw","created_at":"2026-02-10T22:21:09.811539531Z","created_by":"root","updated_at":"2026-02-11T11:08:09.14839814Z","closed_at":"2026-02-11T11:08:09.14839814Z","close_reason":"30 envelope validation tests covering all test cases from bead spec","dependencies":[{"issue_id":"rch-mac-666.3","depends_on_id":"rch-mac-666","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-666.3","depends_on_id":"rch-mac-666.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-666.4","title":"Job lifecycle and idempotency tests","description":"Test job lifecycle and idempotency via mock worker. All tests use the mock worker with controllable state transitions.\n\n**Test cases:**\n\n1. **Happy path lifecycle:**\n   - Submit new job → response `ok: true`, job enters QUEUED\n   - Poll status → transitions QUEUED → RUNNING → SUCCEEDED\n   - Pass: final status response shows `state: \"SUCCEEDED\"`, artifacts available via fetch\n\n2. **Idempotent submit — already COMPLETE:**\n   - Submit job_id=J1, wait for SUCCEEDED\n   - Submit job_id=J1 again with same job_key → response `ok: true`, MAY return existing artifacts\n   - Pass: no re-execution, artifacts unchanged\n\n3. **Idempotent submit — currently RUNNING:**\n   - Submit job_id=J2, mock holds in RUNNING\n   - Submit job_id=J2 again with same job_key → response reports RUNNING status\n   - Pass: tailing still works, no duplicate execution\n\n4. **Submit with mismatched job_key:**\n   - Submit job_id=J3 with job_key=K1, complete successfully\n   - Submit job_id=J3 with job_key=K2 → MUST reject\n   - Pass: `ok: false`, error indicates job_key mismatch to prevent artifact confusion\n\n5. **job_key validation on submit:**\n   - Submit job where `job_key` != SHA-256(JCS(`job_key_inputs`)) → MUST reject with `failure_kind=PROTOCOL_ERROR`\n   - Submit job where `job_key_inputs.source_sha256` doesn't match stored bundle digest → MUST reject with diagnostics\n   - Pass: rejection with clear error, no execution started\n\n6. **Source not present:**\n   - Submit job referencing source_sha256 not in store → `error.code: \"SOURCE_MISSING\"`\n   - Pass: exact error code, no generic failure\n\n7. **TOCTOU race (SOURCE_MISSING after has_source):**\n   - has_source returns true, then GC evicts bundle before submit\n   - submit returns SOURCE_MISSING → host re-uploads via upload_source → retry submit succeeds\n   - Pass: end-to-end recovery works, only one retry\n\n8. **Cancellation lifecycle:**\n   - Submit job_id=J4, mock enters RUNNING\n   - Send cancel → job transitions RUNNING → CANCEL_REQUESTED → CANCELLED\n   - Pass: summary.json has `status=cancelled`, `failure_kind=CANCELLED`, `exit_code=80`\n\n9. **Capacity exceeded:**\n   - Set mock to max_concurrent_jobs=1, submit two jobs\n   - Second submit → `error.code: \"BUSY\"`, response includes `retry_after_seconds` (int \u003e 0)\n   - Pass: exact error code, retry_after_seconds present and positive\n\n10. **Orphaned job cleanup:**\n    - Create partial artifact directory for job_id=J5 (no job_index.json, job not running)\n    - Submit job_id=J5 → worker MUST clean up partial dir and re-execute from scratch\n    - Pass: job completes successfully, no partial artifact contamination\n\n**Pass/fail:** Each scenario has explicit expected state transitions and response fields. Test fails on any mismatch. Mock worker must support controllable timing (hold in RUNNING, simulate GC, etc.).\n\n**Logging:** Worker MUST log at INFO: job state transitions (QUEUED→RUNNING→SUCCEEDED/FAILED/CANCELLED). At WARN: orphaned job cleanup. Tests verify log contains state transition entries for happy path.\n","status":"closed","priority":1,"issue_type":"task","assignee":"Paul Robinshaw","created_at":"2026-02-10T22:21:10.471219764Z","created_by":"root","updated_at":"2026-02-11T11:09:41.390036835Z","closed_at":"2026-02-11T11:09:41.390036835Z","close_reason":"25 job lifecycle and idempotency tests covering all scenarios from bead spec","dependencies":[{"issue_id":"rch-mac-666.4","depends_on_id":"rch-mac-666","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-666.4","depends_on_id":"rch-mac-666.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-666.5","title":"Binary framing tests (upload_source/fetch)","description":"Test binary framing protocol for upload_source and fetch operations against the mock worker.\n\n**Binary framing format:** A single compact UTF-8 JSON header line terminated by `\\n`, followed by exactly `content_length` raw bytes when `payload.stream` is present.\n\n**Test cases:**\n\n1. **upload_source happy path:**\n   - Input: JSON header with `payload.stream.content_length=1024`, `content_sha256=\u003ccorrect\u003e`, `compression=none`, `format=tar`, followed by 1024 bytes of tar data\n   - Expected: `ok: true`, bundle stored under `source_sha256` key\n   - Pass: worker accepts, subsequent `has_source` returns `{exists: true}`\n\n2. **upload_source with zstd compression:**\n   - Input: zstd-compressed tar, header has `compression=zstd`, `content_sha256` of compressed bytes\n   - Expected: worker decompresses, verifies decompressed canonical bundle digest matches `source_sha256`\n   - Pass: bundle stored correctly, has_source returns true\n\n3. **content_length mismatch — too few bytes:**\n   - Header says content_length=1024, send only 512 bytes then EOF\n   - Expected: worker rejects (read error or timeout), no partial bundle stored\n   - Pass: error response, `has_source` returns false\n\n4. **content_length mismatch — too many bytes:**\n   - Header says content_length=1024, send 2048 bytes\n   - Expected: worker reads exactly 1024 bytes, ignores remainder (or rejects)\n   - Pass: defined behavior (document which)\n\n5. **content_sha256 mismatch:**\n   - Header has correct content_length but wrong content_sha256\n   - Expected: worker MUST reject before processing, bundle NOT stored\n   - Pass: error response mentioning sha256 mismatch\n\n6. **Canonical bundle digest mismatch (after decompression):**\n   - content_sha256 matches compressed bytes, but decompressed tar has wrong source_sha256\n   - Expected: worker rejects with diagnostics\n   - Pass: error distinguishes \"transport integrity ok, bundle content wrong\"\n\n7. **Framing discriminator:**\n   - Request WITHOUT `payload.stream` → entire stdin is single JSON, no binary follows\n   - Request WITH `payload.stream` → parse as header line + binary\n   - Pass: both modes work correctly in same session\n\n8. **Header must be compact single-line JSON:**\n   - Send pretty-printed multi-line JSON header → protocol violation\n   - Pass: worker rejects (cannot parse header line)\n\n9. **Header with unescaped newline in string value:**\n   - JSON string containing literal `\\n` (0x0a) in a field value → protocol violation\n   - Pass: worker rejects or header parse fails at first newline\n\n10. **fetch response (binary-framed):**\n    - Request fetch for completed job\n    - Expected: response is binary-framed (NOT standard RPC envelope): JSON header line with `protocol_version`, `request_id`, `ok: true`, `job_id`, `manifest` (inline), `stream` object, followed by tar bytes\n    - Verify: `content_sha256` of received bytes matches header, manifest integrity matches fetched files\n    - Pass: all integrity checks pass, artifacts extractable\n\n11. **fetch — ARTIFACTS_GONE:**\n    - Request fetch for job whose artifacts have been GC'd\n    - Expected: `error.code: \"ARTIFACTS_GONE\"`\n    - Pass: exact error code\n\n12. **upload_source atomicity (concurrent uploads):**\n    - Two concurrent uploads of same `source_sha256`\n    - Expected: both succeed, only one bundle stored (write-to-temp-then-rename)\n    - Pass: no corruption, has_source returns true\n\n13. **PAYLOAD_TOO_LARGE:**\n    - Worker capabilities has `max_upload_bytes=1048576`, upload with content_length=2097152\n    - Expected: `error.code: \"PAYLOAD_TOO_LARGE\"`, `error.data.max_bytes=1048576`\n    - Pass: exact error code and limit in data\n\n**Pass/fail:** Each test specifies exact expected behavior. Integrity checks use known fixture bundles with pre-computed sha256 values. Tests use mock worker with controllable storage.\n\n**Logging:** Worker MUST log at INFO: upload_source received (source_sha256, content_length). At DEBUG: sha256 verification result. At WARN: sha256 mismatch details. Tests verify log entries for happy path and mismatch cases.\n","status":"closed","priority":1,"issue_type":"task","assignee":"Paul Robinshaw","created_at":"2026-02-10T22:21:11.207598246Z","created_by":"root","updated_at":"2026-02-11T11:11:31.119045635Z","closed_at":"2026-02-11T11:11:31.119045635Z","close_reason":"19 binary framing tests covering upload_source, fetch, and integration flows","dependencies":[{"issue_id":"rch-mac-666.5","depends_on_id":"rch-mac-666","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-666.5","depends_on_id":"rch-mac-666.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-81k","title":"Structured events (events.jsonl)","description":"Worker should emit events.jsonl (JSON Lines) for machine-readable progress. Each event: ts, stage, kind, optional data. Idle-log watchdog should treat either new log bytes OR new events as activity. Part of the rich artifact profile but useful for all builds.","acceptance_criteria":"- events.jsonl emitted per job in JSON Lines format\n- Each event includes: ts (RFC 3339 UTC), stage (string), kind (string), optional data (object)\n- Idle-log watchdog (axz.13/axz.20) treats new events as activity\n- Events written incrementally during execution (not buffered to end)","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-10T22:21:57.883125064Z","created_by":"root","updated_at":"2026-02-11T07:57:39.473661454Z","dependencies":[{"issue_id":"rch-mac-81k","depends_on_id":"rch-mac-axz.10","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz","title":"M2: MVP Remote Execution (xcodebuild backend)","description":"Milestone 2: End-to-end remote Xcode build/test execution using direct xcodebuild invocation. This is the core MVP — a classified invocation is bundled, sent to a worker, executed, and artifacts are returned. Includes source bundling, run planning, destination resolution, worker selection, job submission, status polling, artifact fetching, state machine management, timeouts, retries, signal handling, and all host-side CLI commands. Backend is direct xcodebuild (not XcodeBuildMCP). Sequential step execution with abort-on-first-failure default.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-10T22:21:12.012830742Z","created_by":"root","updated_at":"2026-02-10T22:21:12.012830742Z","dependencies":[{"issue_id":"rch-mac-axz","depends_on_id":"rch-mac-666","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz","depends_on_id":"rch-mac-n4q","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.1","title":"Configuration merge system","description":"Implement the 4-layer configuration merge system.\n\n## Sources in precedence order (last wins)\n1. **Built-in lane defaults**: hardcoded in the binary. Includes: overall_seconds=1800, idle_log_seconds=300, connect_timeout_seconds=30, bundle.mode=\"worktree\", artifact_profile=\"minimal\", continue_on_failure=false, worker_selection.mode=\"deterministic\", cache.derived_data=\"off\", cache.spm=\"off\".\n2. **Host/user config**: `~/.config/rch/xcode.toml` (TOML format, same key structure as repo config but host-scoped settings like default worker tags, timeout overrides, probe_ttl_seconds).\n3. **Repo config**: `.rch/xcode.toml` (in-repo, included in source bundle).\n4. **CLI flags**: command-line overrides (e.g. `--timeout 600`, `--action build`).\n\n## Merge semantics\n- Decode all config into JSON-compatible object model (maps, arrays, scalars).\n- Objects: deep-merge by key.\n- Arrays: REPLACE (no concatenation — prevents host-dependent ordering surprises).\n- Scalars: override.\n- Merge MUST be deterministic.\n\n## Output: merged effective_config object\nThis bead produces the merged config as an in-memory object. It is embedded in job.json by the JobSpec builder (axz.5) under the `effective_config` field. The actual `effective_config.json` artifact file is written by the worker executor (axz.10) from the job.json data.\n\n## effective_config schema\nSchema: schema_version, schema_id (rch-xcode/effective_config@1), created_at, run_id, job_id, job_key, merged config object, contributing sources[] (each with: origin [\"builtin\"|\"host\"|\"repo\"|\"cli\"], path [file path or null], digest [sha256 hex of raw bytes or null for builtin/cli]), redactions[] (list of redacted key paths). Secrets (private keys, tokens, passwords) MUST be redacted with placeholder \"[REDACTED]\". effective_config MUST NOT be used for job_key computation.\n\n## Config validation\nReject before run execution with clear diagnostic if: overall_seconds not in (0, 86400], idle_log_seconds not in (0, overall_seconds], connect_timeout_seconds not in (0, 300].\n","acceptance_criteria":"- 4-layer merge produces correct results: built-in \u003c host \u003c repo \u003c CLI\n- Objects deep-merge; arrays replace; scalars override\n- Merge is deterministic (same inputs → same output)\n- Merged effective_config object embedded in job.json (worker emits the artifact file via axz.10)\n- effective_config schema includes: schema_version, schema_id (rch-xcode/effective_config@1), created_at, run_id, job_id, job_key, merged config, contributing_sources[], redactions[]\n- Secrets redacted with redactions[] recorded\n- Out-of-bounds timeout values rejected before run execution with clear diagnostic\n- Contributing sources recorded with origin, path, and raw-bytes digest","notes":"\n## Error handling and recovery\n\n### Config file errors\n- Host config missing: skip silently (optional). Unreadable: fail with diagnostic.\n- Repo config missing: fail with diagnostic (required for Xcode lane). Malformed TOML: fail with line/column.\n\n### TOML parse errors\n- Include file path, line number, column. Fail fast, no partial parsing.\n\n### Secret detection\n- Keyword heuristic: field names containing secret/token/password/key/credential (case-insensitive).\n- Redaction failure: log warning, include field without redaction rather than crashing.\n\n### Config stability\n- Read once at run start. Changes during execution not detected (by design).\n- contributing_sources[].digest enables post-hoc drift detection between runs.","status":"closed","priority":1,"issue_type":"task","assignee":"EmeraldHeron","created_at":"2026-02-10T22:21:12.680179902Z","created_by":"root","updated_at":"2026-02-11T11:41:18.036967877Z","closed_at":"2026-02-11T11:41:18.036684931Z","dependencies":[{"issue_id":"rch-mac-axz.1","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.10","title":"Worker executor: xcodebuild backend","description":"Implement the xcodebuild backend executor on the worker. This bead covers the core execution logic ONLY — capacity enforcement, job lifecycle/idempotency, and state machine transitions are wired via the RPC entrypoint (sai.5) and state machine (axz.11); timeout enforcement on the host side is axz.20.\n\n## Scope (what this bead implements)\n1. Create isolated working directory unique per job_id under a configurable job root (e.g. `\u003cjobs_root\u003e/\u003cjob_id\u003e/work/`).\n2. Extract source bundle from the content-addressed store into the working directory.\n3. Set `DEVELOPER_DIR` to the resolved toolchain `developer_dir` from job.json.\n4. Apply environment allowlist (drop-by-default): only pass through a documented set of known-safe env vars (`HOME`, `PATH`, `TMPDIR`, `DEVELOPER_DIR`, `LANG`, `LC_ALL`). Redact everything else. Log dropped keys (not values) for diagnostics.\n5. Construct the xcodebuild command from job.json fields:\n   - Use `job.job_key_inputs.sanitized_argv` directly as the xcodebuild invocation. Note: sanitized_argv already includes the action as its first element (e.g. `[\"build\", \"-scheme\", ...]` per n4q.1 canonical ordering), so the executor MUST NOT prepend `job.action` separately. Use `job.action` only for dispatch logic (e.g. deciding whether to inject `-resultBundlePath`), not for constructing the command line.\n   - For test jobs: inject `-resultBundlePath \u003cjob_artifact_dir\u003e/result.xcresult` (worker controls, NOT from user args)\n   - For DerivedData: set `-derivedDataPath` per cache mode config (`per_job`: `\u003cjob_artifact_dir\u003e/DerivedData`; `shared`: use shared cache path; `off`: let Xcode default)\n6. Execute xcodebuild as a child process:\n   - Capture combined stdout/stderr to `\u003cjob_artifact_dir\u003e/build.log` (streaming, not buffered)\n   - Track the child PID for cancellation (SIGTERM → wait grace → SIGKILL)\n   - Record wall-clock start/end timestamps\n7. On completion, write normative artifacts to `\u003cjob_artifact_dir\u003e/`:\n   - `summary.json`: schema per PLAN.md (schema_id=rch-xcode/summary@1), `backend=\"xcodebuild\"`, map xcodebuild exit code to stable exit_code (0→0 success, nonzero→50 XCODEBUILD_FAILED), record `backend_exit_code`, `backend_term_signal` if killed by signal, `duration_ms`, `human_summary`\n   - `toolchain.json`: emit per schema (rch-xcode/toolchain@1) with resolved values from job.json (this bead owns file emission on the worker; axz.21 owns resolution on the host and recording values in job_key_inputs)\n   - `destination.json`: emit per schema (rch-xcode/destination@1) with resolved values from job.json (this bead owns file emission on the worker; axz.4 owns resolution on the host)\n   - `effective_config.json`: emit per schema (rch-xcode/effective_config@1) from job.json.effective_config (this bead owns file emission on the worker; axz.1 owns the merge logic on the host)\n   - `build.log`: already streaming during execution\n   - `result.xcresult/`: present for test jobs (created by xcodebuild via -resultBundlePath)\n8. On cancellation (SIGTERM received from RPC layer): terminate process tree, write summary.json with status=cancelled, failure_kind=CANCELLED, exit_code=80.\n9. On host-initiated timeout (cancel RPC with timeout reason from host): terminate and write summary.json with the failure_subkind conveyed by the cancel request (TIMEOUT_OVERALL or TIMEOUT_IDLE). There is no independent worker-side timeout watchdog; all timeout enforcement is host-driven via axz.20, communicated to the worker through the cancel RPC.\n\n## Out of scope (handled by other beads)\n- Capacity enforcement / BUSY responses → sai.5 (RPC entrypoint)\n- job_id idempotency checks → sai.5 / axz.11\n- job_key validation (SHA-256 of JCS) → sai.5\n- Source bundle store (has_source/upload) → axz.9\n- Host-side timeout enforcement → axz.20\n- Manifest, attestation, job_index → y6s.*\n- Structured events → 81k\n- Agent-friendly summaries → t7z\n","acceptance_criteria":"- Given a valid job.json with action=build, executor runs xcodebuild build, writes build.log and summary.json with correct exit_code mapping.\n- Given action=test, executor additionally produces result.xcresult/ via -resultBundlePath.\n- DEVELOPER_DIR is set correctly (verified in build.log or executor_env diagnostics).\n- Env allowlist is enforced: only declared keys are passed through.\n- Cancellation produces summary.json with status=cancelled, exit_code=80.\n- Isolated working directory is created per job_id and does not collide with other jobs.\n- backend_exit_code reflects the raw xcodebuild exit status.\n- backend_term_signal is recorded when process killed by signal.\n- summary.json includes all normative fields from PLAN.md summary schema.","notes":"## Error handling and recovery\n\n### Source extraction failure\n- If tar extraction fails (corrupted, disk full, permission error), write summary.json with status=failed, failure_kind=TRANSFER, failure_subkind=EXTRACTION_FAILED.\n- Partially extracted files MUST be cleaned up.\n\n### xcodebuild process management\n- If xcodebuild fails to start (binary missing, permission denied): summary.json with failure_kind=EXECUTOR, backend_exit_code=null.\n- If killed by OOM (SIGKILL from kernel): record backend_term_signal=SIGKILL, mention possible OOM in human_summary.\n- Process tree cleanup: use process group kill (killpg) not just PID kill.\n\n### Disk full during execution\n- If build.log write fails with ENOSPC: attempt minimal summary.json (status=failed, failure_subkind=DISK_FULL). If even that fails, log to stderr.\n\n### Partial artifact writes\n- All artifact files MUST be written atomically (write-to-temp-then-rename).\n- If any artifact write fails, still attempt summary.json (last-resort diagnostic).\n\n### Working directory cleanup\n- Success: may clean up per config (default: keep for debugging).\n- Failure/cancellation: MUST preserve for post-mortem analysis.\n\n## Testability requirements\n\n### Interface isolation (MUST for testability)\nThe executor MUST be structured with injectable dependencies so it can be unit-tested without macOS/Xcode:\n1. **ProcessLauncher interface**: abstracts child process creation (xcodebuild). Mock returns configurable exit codes, stdout/stderr, and signals. Real implementation uses os/exec.\n2. **FileSystem interface**: abstracts working directory creation, source extraction, artifact writing. Mock uses in-memory filesystem. Enables testing artifact write ordering, atomic writes, and disk-full scenarios.\n3. **Clock interface**: abstracts time for duration_ms computation. Mock returns deterministic timestamps.\n4. **Environment interface**: abstracts env var filtering. Pure function: takes full env map + allowlist → returns filtered env map + dropped keys. Already covered in axz.24 test #14.\n\n### What CAN be unit tested (with mocks)\n- Exit code mapping: xcodebuild exit → summary.json exit_code (pure function)\n- Command construction: job.json → xcodebuild argv (pure function, verify -resultBundlePath injected for test, sanitized_argv used correctly, action NOT prepended)\n- Env allowlist filtering (pure function)\n- Artifact schema correctness: given mock execution result → verify summary.json, toolchain.json, destination.json field correctness\n- Working directory path derivation: job_id → expected directory path\n- Cancellation signal sequence: verify SIGTERM sent first, then SIGKILL after grace (via mock ProcessLauncher)\n\n### What requires integration tests (live macOS or heavy mocking)\n- Actual xcodebuild execution (covered by b7s.7 fixture project + b7s.10)\n- Process group kill behavior\n- Real filesystem atomic writes\n","status":"closed","priority":0,"issue_type":"task","assignee":"Opus45","created_at":"2026-02-10T22:21:19.597714631Z","created_by":"root","updated_at":"2026-02-11T19:44:24.227962281+01:00","closed_at":"2026-02-11T19:44:24.227962281+01:00","close_reason":"Worker executor implementation complete: isolated workdirs, source extraction, xcodebuild execution with streaming logs, env allowlist, cancellation support, artifact emission, all tests passing","dependencies":[{"issue_id":"rch-mac-axz.10","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.10","depends_on_id":"rch-mac-axz.18","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.10","depends_on_id":"rch-mac-axz.21","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.10","depends_on_id":"rch-mac-axz.9","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.10","depends_on_id":"rch-mac-sai.5","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.11","title":"Run and job state machine implementation","description":"Implement run and job state machines per PLAN.md. Run states: QUEUED → RUNNING → {SUCCEEDED | FAILED | CANCELLED}. Job states: QUEUED → RUNNING → {SUCCEEDED | FAILED | CANCELLED}, with CANCEL_REQUESTED as intermediate. State artifacts: run_state.json at \u003crun_id\u003e/run_state.json with schema_version, schema_id (rch-xcode/run_state@1), run_id, state, created_at, updated_at, optional current_step ({index, job_id, action} or null), optional seq (monotonic counter). job_state.json at \u003crun_id\u003e/steps/\u003caction\u003e/\u003cjob_id\u003e/job_state.json with schema_version, schema_id (rch-xcode/job_state@1), run_id, job_id, job_key, state, created_at, updated_at, optional seq. Both must be updated atomically (write-then-rename) on every state transition. Timestamps: RFC 3339 with UTC offset (Z suffix). Clock skew: host and worker clocks are independent, do not assume cross-machine timestamp monotonicity, prefer seq for ordering within single machine.","acceptance_criteria":"- Run states transition correctly: QUEUED → RUNNING → {SUCCEEDED | FAILED | CANCELLED}\n- Job states transition correctly: QUEUED → RUNNING → {SUCCEEDED | FAILED | CANCELLED} with CANCEL_REQUESTED intermediate\n- run_state.json written atomically (write-then-rename) on every transition at \u003crun_id\u003e/run_state.json\n- job_state.json written atomically on every transition at \u003crun_id\u003e/steps/\u003caction\u003e/\u003cjob_id\u003e/job_state.json\n- Both include schema_version, schema_id, timestamps (RFC 3339 UTC), and optional seq counter\n- run_state.json includes current_step for observability\n- Invalid state transitions are rejected (e.g. SUCCEEDED → RUNNING)\n- seq is monotonically increasing within each artifact","notes":"\n## Error handling and recovery\n\n### Crash during atomic write\n- Write-then-rename is POSIX atomic. Crash after write but before rename leaves orphaned temp. Host reads last successfully renamed state file on restart.\n\n### Corrupted state files\n- If state JSON fails to parse: treat as UNKNOWN.\n- run_state.json UNKNOWN on resumption: scan job_state.json files to reconstruct.\n- job_state.json UNKNOWN: query worker via status RPC.\n\n### Seq counter persistence\n- seq derived from current file value (read-increment-write), not in-memory counter alone. Correct after restart.\n\n### Concurrent access\n- Host: single writer per run, no locking needed.\n- Worker: state updates MUST be serialized (per-job mutex or single-writer pattern).","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:20.409943675Z","created_by":"root","updated_at":"2026-02-11T13:56:41.315772553Z","closed_at":"2026-02-11T13:56:41.315690671Z","close_reason":"Implementation complete: RunStateData and JobStateData structs with all required fields (schema_version, schema_id, run_id, state, created_at, updated_at, seq), proper state transitions (QUEUED → RUNNING → {SUCCEEDED|FAILED|CANCELLED}), CancelRequested intermediate state for jobs, atomic write-then-rename persistence, RFC 3339 timestamps, and monotonic sequence counter. Code in src/state/{mod.rs,run_state.rs,job_state.rs} with comprehensive unit tests.","dependencies":[{"issue_id":"rch-mac-axz.11","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.12","title":"Host signal handling (SIGINT/SIGTERM)","description":"On receiving SIGINT or SIGTERM: 1) Send cancel RPC for all RUNNING jobs in current run. 2) Wait up to grace period (recommended 10 seconds) for cancellation acknowledgement. 3) Persist run_state.json with state=CANCELLED and run_summary.json with available results. 4) Exit with code 80 (CANCELLED). On second SIGINT (double-interrupt): may exit immediately without waiting for cancellation ack, but MUST still persist run_state.json. First SIGINT must dispatch cancel RPCs before returning (fire-and-forget acceptable). On cancellation, summary.json must set status=cancelled, failure_kind=CANCELLED, exit_code=80.","acceptance_criteria":"- SIGINT sends cancel RPC for all RUNNING jobs in current run\n- Grace period wait (10s) for cancellation ack\n- run_state.json persisted with state=CANCELLED before exit\n- run_summary.json emitted with available results\n- Exit code 80 (CANCELLED)\n- Double-SIGINT exits immediately but still persists run_state.json\n- First SIGINT dispatches cancel RPCs before returning","notes":"\n## Error handling and recovery\n\n### Cancel RPC failure during signal handling\n- Cancel RPCs fail: still persist run_state.json and exit. Fire-and-forget acceptable.\n\n### State persistence failure\n- Disk full: log to stderr, exit with code 80. Signal handler MUST NOT hang.\n\n### Re-entrant signal handling\n- First SIGINT: cancellation flag, cancel RPCs, grace timer.\n- Second SIGINT: immediate-exit flag, skip ack wait.\n- Signal handler MUST be async-signal-safe (flag-based, no allocations).\n- Third+ SIGINT: ignored.\n\n### Cleanup ordering\n1. Set cancellation flag 2. Send cancel RPCs 3. Wait for ack (skip on double-SIGINT) 4. Persist run_state.json (ALWAYS) 5. run_summary.json (best-effort) 6. Exit 80.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:21.042501828Z","created_by":"root","updated_at":"2026-02-11T16:14:13.138122458Z","closed_at":"2026-02-11T16:14:13.137993659Z","close_reason":"Signal handling module implemented with 11 passing tests - SignalState, SignalHandler, CancellationCoordinator for SIGINT/SIGTERM handling with grace period and double-interrupt support","dependencies":[{"issue_id":"rch-mac-axz.12","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.12","depends_on_id":"rch-mac-axz.11","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.13","title":"Log streaming (tail) and idle watchdog","description":"Implement log streaming via cursor-based tail RPC and idle-log watchdog.\n\n## Tail RPC interaction\nRequest payload (sent by host via axz.8): job_id, cursor (nullable for first request), optional max_bytes/max_events. Response payload (from worker via sai.5): next_cursor (nullable when complete), log_chunk (UTF-8 text) and/or events (array of event objects or JSONL strings). Host loops tail calls to stream logs while job is RUNNING.\n\n## Tail loop\n- Poll interval: configurable (recommended 1-2 seconds)\n- On each response with data: update last_activity_timestamp (used by axz.20 idle watchdog)\n- On next_cursor=null: job has finished producing output; stop tailing\n- If worker lacks `tail` feature (not in probe features list): fall back to periodic `status` checks to avoid silent hangs; fetch final build.log via `fetch` after completion\n\n## Activity tracking (interface with axz.20)\nThis bead MUST expose the last_activity_timestamp to the timeout enforcement (axz.20). Activity is defined as: new log bytes in log_chunk OR new events in events array. Empty responses (no new data) do NOT count as activity. The idle watchdog in axz.20 compares current time against last_activity_timestamp; if the gap exceeds idle_log_seconds, axz.20 sends a cancel RPC with reason=TIMEOUT_IDLE.\n\n## Fallback mode\nIf worker does not advertise `tail` in its features list, host must periodically call `status` to check if the job is still RUNNING. This prevents silent hangs but provides no streaming output. After job completes, fetch full build.log via the normal artifact fetch path.\n","acceptance_criteria":"- Cursor-based tail loop streams logs while job is RUNNING\n- Request: {job_id, cursor, max_bytes?, max_events?} → Response: {next_cursor, log_chunk?, events?}\n- Fallback to periodic status checks if worker lacks tail feature\n- Exposes last_activity_timestamp to timeout enforcement (axz.20): new log bytes OR new events update it; empty responses do NOT\n- axz.20 reads last_activity_timestamp to enforce idle_log_seconds (this bead does NOT send cancel itself)","notes":"## Error handling and recovery\n\n### SSH session drops during tail\n- Tail RPC failure: log warning, wait one poll interval, retry with same cursor.\n- After 3 consecutive failures: fall back to status-only polling mode.\n- On recovery: reset failure counter. Cursor preserved across retries (never reset to null).\n\n### Worker returns error for tail\n- INVALID_REQUEST (bad cursor): reset cursor to null (restart), log warning about possible duplicated output.\n- Other errors: transient, retry with same cursor.\n\n### Tail loop termination\n- Normal: next_cursor=null.\n- Abnormal: job in terminal state but tail never returns null. Stop after detecting terminal state via status, drain with final tail.\n- Guard: same cursor returned N times (default 10) with no data AND terminal state -\u003e stop.\n\n## Testability requirements\n\n### Interface isolation (MUST for testability)\n1. **RpcClient interface**: mock returns configurable tail responses (log chunks, cursors, errors). No SSH needed.\n2. **Clock interface**: mock for deterministic idle watchdog testing. Advance time to trigger idle timeout without real waits.\n3. **ActivityTracker**: exposed interface that axz.20 reads. Must be testable in isolation — given a sequence of tail responses, verify last_activity_timestamp updates correctly.\n\n### Unit-testable scenarios\n- Cursor management: initial null → first cursor → subsequent cursors → null (complete)\n- Activity detection: response with log_chunk → activity updated; empty response → NOT updated; response with events → activity updated\n- Fallback decision: worker lacks `tail` feature → fallback mode selected\n- Stale cursor guard: same cursor N times with terminal state → loop exits\n- Retry on tail error: 3 consecutive failures → fallback to status polling\n\n### These tests need NO SSH, NO real worker, NO real clock\n","status":"closed","priority":1,"issue_type":"task","assignee":"Opus","created_at":"2026-02-10T22:21:21.770154502Z","created_by":"root","updated_at":"2026-02-11T19:43:42.163991754+01:00","closed_at":"2026-02-11T19:43:41.989280889+01:00","dependencies":[{"issue_id":"rch-mac-axz.13","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.13","depends_on_id":"rch-mac-axz.8","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.14","title":"Cancellation support","description":"Implement cancellation support for both host-initiated and CLI-initiated cancellation.\n\n## Cancel RPC payload\nHost sends cancel RPC with: `job_id` (required), `reason` (optional string: `USER`, `TIMEOUT_OVERALL`, `TIMEOUT_IDLE`, `SIGNAL`). The `reason` field allows the host to communicate WHY it is cancelling, so the worker can set the appropriate `failure_subkind` in summary.json. Default reason if omitted: `USER`.\n\n## Worker cancel behavior\n1. Attempt best-effort cancel by terminating backend process tree (SIGTERM then SIGKILL after grace period).\n2. Write artifacts with status=cancelled, failure_kind=CANCELLED, exit_code=80.\n3. If reason is TIMEOUT_OVERALL or TIMEOUT_IDLE, set failure_subkind accordingly in summary.json (exit_code remains 80).\n4. Still emit build.log with whatever output was captured before cancellation.\n5. Transition job state: RUNNING → CANCEL_REQUESTED → CANCELLED. CANCEL_REQUESTED is intermediate while backend is being terminated.\n\n## Host-side cancel flows\n- **CLI**: `rch xcode cancel \u003crun_id|job_id\u003e` — sends cancel for the specified run or job. If run_id provided, cancel ALL running jobs in that run. Uses reason=USER.\n- **Signal handling** (axz.12): SIGINT/SIGTERM triggers cancel for all running jobs with reason=SIGNAL.\n- **Timeout** (axz.20): overall/idle timeout triggers cancel with reason=TIMEOUT_OVERALL or TIMEOUT_IDLE.\n\n## Lease-based backstop\nIf worker supports leases, auto-cancel RUNNING jobs whose lease expires without release (safety net for host crashes). Lease-expired cancellations use failure_kind=CANCELLED with failure_subkind=LEASE_EXPIRED.\n","acceptance_criteria":"- cancel RPC sent to worker with job_id\n- Worker terminates backend process tree (SIGTERM → grace → SIGKILL)\n- Artifacts written with status=cancelled, failure_kind=CANCELLED, exit_code=80\n- build.log includes output captured before cancellation\n- rch xcode cancel \u003crun_id\u003e cancels ALL running jobs in that run\n- rch xcode cancel \u003cjob_id\u003e cancels single job\n- Job state transitions: RUNNING → CANCEL_REQUESTED → CANCELLED\n- Integrates with signal handling (SIGINT triggers cancel)","notes":"\n## Error handling and recovery\n\n### Cancel RPC fails (worker unreachable)\n- Still transition local state to CANCELLED. Lease backstop handles worker side.\n- No lease: job may run to completion (orphaned execution). Log warning.\n\n### Process tree cleanup\n- Zombie processes: waitpid after SIGKILL. If fails, log warning, continue.\n- Process group already dead: ESRCH from killpg -\u003e treat as success.\n- Natural completion during cancel: use natural result, not CANCELLED.\n\n### Partial artifacts on cancellation\n- build.log may be incomplete (expected). result.xcresult may not exist (expected).\n- summary.json MUST still be written with status=cancelled.\n\n### Double/redundant cancellation\n- Cancel on already-cancelled or completed job: no-op, return success.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:22.54174395Z","created_by":"root","updated_at":"2026-02-11T16:17:30.347828704Z","closed_at":"2026-02-11T16:17:30.347757041Z","close_reason":"Cancellation support implemented: CancellationManager, JobCancellation, RunCancellation types with CLI 'rch xcode cancel' command - 23 passing tests","dependencies":[{"issue_id":"rch-mac-axz.14","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.14","depends_on_id":"rch-mac-axz.11","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.14","depends_on_id":"rch-mac-axz.8","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.15","title":"rch xcode artifacts command","description":"Implement rch xcode artifacts \u003crun_id|job_id\u003e CLI command. Prints the local artifact path(s) and key files (summary/xcresult/log). Simple diagnostic command for inspecting results.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-10T22:21:23.27332245Z","created_by":"root","updated_at":"2026-02-10T22:21:23.27332245Z","dependencies":[{"issue_id":"rch-mac-axz.15","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.15","depends_on_id":"rch-mac-axz.11","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.16","title":"Dry-run mode (--dry-run)","description":"Implement rch xcode verify --dry-run. Prints resolved JobSpec + chosen worker without executing. Runs classifier, resolves destination, builds JobSpec, selects worker, but does not bundle sources or submit to worker. Useful for validating config and checking what would happen.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-10T22:21:24.131497584Z","created_by":"root","updated_at":"2026-02-10T22:21:24.131497584Z","dependencies":[{"issue_id":"rch-mac-axz.16","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.16","depends_on_id":"rch-mac-axz.5","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.16","depends_on_id":"rch-mac-axz.7","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.17","title":"CLI commands: verify, run, tail","description":"Implement the main CLI entry points for the Xcode lane. This is the top-level orchestration bead that wires together all the subsystems.\n\n## Commands in scope\n1. **rch xcode verify** — primary workflow. Read .rch/xcode.toml verify actions, classify each, build run plan, choose worker, bundle sources, submit jobs sequentially, stream logs, return aggregated result via run_summary.json. Integrates: classifier (n4q.1), run builder (axz.6), worker selection (axz.7), source bundling (axz.2), RPC transport (axz.8), state machine (axz.11), log streaming (axz.13), signal handling (axz.12), cancellation (axz.14), run summary (axz.19).\n2. **rch xcode run --action \u003cbuild|test\u003e** — single action as one-step run. Same pipeline as verify but with a single step.\n3. **rch xcode tail \u003crun_id|job_id\u003e** — stream logs/events with cursor-based pagination. Falls back to polling if worker lacks tail feature. Can attach to an in-progress or completed run.\n\n## Commands handled by other beads\n- `rch xcode cancel` → axz.14\n- `rch xcode artifacts` → axz.15\n- `rch xcode explain` → n4q.4\n- `rch xcode verify --dry-run` → axz.16\n\n## Orchestration flow (verify)\n1. Load and merge config (axz.1)\n2. Validate timeout bounds (axz.20)\n3. Read verify actions from repo config\n4. Classify each action (n4q.1)\n5. Select worker (axz.7) — once per run\n6. Resolve toolchain (axz.21) and destinations (axz.4)\n7. Build run plan (axz.6) — allocate job_ids, emit run_plan.json\n8. Create source bundle (axz.2) — once per run (shared source)\n9. Emit run_state.json (QUEUED → RUNNING)\n10. For each step (sequential, abort-on-failure unless continue_on_failure):\n    a. Check if source already on worker (has_source), upload if needed\n    b. Build JobSpec (axz.5), emit job.json\n    c. Submit job via RPC (axz.8)\n    d. Stream logs via tail (axz.13), enforce timeouts (axz.20)\n    e. Fetch artifacts on completion\n    f. Update job_state.json and run_state.json\n11. Emit run_summary.json (axz.19)\n12. Exit with aggregated exit code\n\n## Exit behavior\nHost CLI MUST exit with the run-level exit_code from run_summary.json. All normative artifacts must be written before exit, even on failure.\n","acceptance_criteria":"- rch xcode verify: reads .rch/xcode.toml, classifies, builds run plan, executes, returns aggregated result\n- rch xcode run --action \u003cbuild|test\u003e: single-step run\n- rch xcode tail \u003crun_id|job_id\u003e: streams logs with cursor pagination\n- All commands use config merge system, enforce timeout validation, emit proper exit codes\n- verify integrates full pipeline: classifier → run builder → worker selection → bundling → RPC → state machine → streaming → summary\n- Host exits with run-level exit_code per aggregation rules","notes":"\n## Error handling and recovery\n\n### Run resumption\nOn restart: read run_plan.json, check job_index.json per step (complete if present), query worker for incomplete steps, re-probe and verify protocol_version/toolchain, record resumed_at.\n\n### Partial run cleanup\n- Crash after run_plan.json but before submission: all jobs not started, normal resumption handles.\n- Crash after some completions: completed jobs have job_index.json, rest re-submitted.\n- run_plan.json missing/corrupted: cannot resume, log error, suggest new run.\n\n### Artifact directory conflicts\n- run_id is unique (ULID), conflicts should not occur. If directory exists: fail with diagnostic, don't overwrite.\n\n### Pipeline stage failure principle\nEvery stage failure MUST produce appropriate artifacts before propagating. Always leave artifact directory inspectable.\n## Artifacts NOT emitted in M2\nrun_index.json and job_index.json are M4 artifacts (y6s.4). In M2, the host does NOT emit these index files. Artifact discovery in M2 relies on known directory conventions. The two-phase commit (y6s.5) and commit marker (job_index.json) are also M4. In M2, artifact completeness is determined by summary.json existence.","status":"open","priority":0,"issue_type":"task","created_at":"2026-02-10T22:21:24.891690079Z","created_by":"root","updated_at":"2026-02-11T07:56:32.432459689Z","dependencies":[{"issue_id":"rch-mac-axz.17","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.17","depends_on_id":"rch-mac-axz.10","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.17","depends_on_id":"rch-mac-axz.11","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.17","depends_on_id":"rch-mac-axz.12","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.17","depends_on_id":"rch-mac-axz.13","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.17","depends_on_id":"rch-mac-axz.14","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.17","depends_on_id":"rch-mac-axz.19","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.17","depends_on_id":"rch-mac-axz.6","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.17","depends_on_id":"rch-mac-axz.8","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.18","title":"Failure taxonomy and stable exit codes","description":"Implement the full failure taxonomy in summary.json: status (success|failed|rejected|cancelled), failure_kind (CLASSIFIER_REJECTED|SSH|TRANSFER|EXECUTOR|XCODEBUILD|MCP|ARTIFACTS|CANCELLED|WORKER_INCOMPATIBLE|BUNDLER|ATTESTATION|WORKER_BUSY), failure_subkind (optional: TIMEOUT_OVERALL|TIMEOUT_IDLE|PROTOCOL_ERROR|SIZE_EXCEEDED|INTEGRITY_MISMATCH|FEATURE_MISSING|TOOLCHAIN_CHANGED|PROTOCOL_DRIFT), exit_code (stable integers), backend_exit_code, backend_term_signal, human_summary. Stable exit codes: 0=SUCCESS, 10=CLASSIFIER_REJECTED, 20=SSH/CONNECT, 30=TRANSFER, 40=EXECUTOR, 50=XCODEBUILD_FAILED, 60=MCP_FAILED, 70=ARTIFACTS_FAILED, 80=CANCELLED, 90=WORKER_BUSY, 91=WORKER_INCOMPATIBLE, 92=BUNDLER, 93=ATTESTATION. Run-level exit code aggregation: rejected\u003ecancelled\u003efailed(first failing step exit code)\u003esuccess(0).","acceptance_criteria":"- All failure_kind values defined as constants/enum: CLASSIFIER_REJECTED, SSH, TRANSFER, EXECUTOR, XCODEBUILD, MCP, ARTIFACTS, CANCELLED, WORKER_INCOMPATIBLE, BUNDLER, ATTESTATION, WORKER_BUSY\n- All failure_subkind values defined: TIMEOUT_OVERALL, TIMEOUT_IDLE, PROTOCOL_ERROR, SIZE_EXCEEDED, INTEGRITY_MISMATCH, FEATURE_MISSING, TOOLCHAIN_CHANGED, PROTOCOL_DRIFT\n- Exit codes match PLAN.md table exactly (0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 91, 92, 93)\n- summary.json status field restricted to: success, failed, rejected, cancelled\n- Run-level aggregation: rejected\u003ecancelled\u003efailed(first failing exit code)\u003esuccess\n- Each failure_kind maps to exactly one exit_code","notes":"## Additional failure_subkinds (beyond PLAN.md explicit list)\nThe following failure_subkinds are used by specific beads and are valid extensions:\n- EXTRACTION_FAILED: source bundle extraction failure on worker (used by axz.10 with failure_kind=TRANSFER)\n- DISK_FULL: disk space exhaustion (used by axz.10, axz.9 with various failure_kinds)\nThese follow the schema compatibility rule: adding optional subkinds is backward-compatible.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:25.676617158Z","created_by":"root","updated_at":"2026-02-11T13:09:01.532782707Z","closed_at":"2026-02-11T13:09:01.532550255Z","dependencies":[{"issue_id":"rch-mac-axz.18","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.19","title":"Run summary (run_summary.json)","description":"Emit run_summary.json with: schema_version, schema_id (rch-xcode/run_summary@1), run_id, created_at, status (aggregated), exit_code (aggregated per rules), step_count, steps_succeeded, steps_failed, steps_cancelled, steps_skipped, steps_rejected, duration_ms, human_summary. Exit code aggregation: if any rejected → exit 10, else if any cancelled → exit 80, else if any failed → first failing step exit code, else → 0. Status aggregation follows same precedence.","acceptance_criteria":"- run_summary.json emitted with all fields per PLAN.md schema (schema_id=rch-xcode/run_summary@1)\n- Exit code aggregation correct: rejected→10, cancelled→80, failed→first failing step exit_code, success→0\n- Status aggregation follows same precedence\n- step_count, steps_succeeded, steps_failed, steps_cancelled, steps_skipped, steps_rejected all accurate\n- duration_ms reflects wall-clock run duration\n- human_summary is a single-line readable string","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:26.391565519Z","created_by":"root","updated_at":"2026-02-11T15:32:15.188931965Z","closed_at":"2026-02-11T15:32:15.188799208Z","close_reason":"Run summary implementation complete with 12 passing tests","dependencies":[{"issue_id":"rch-mac-axz.19","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.19","depends_on_id":"rch-mac-axz.11","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.19","depends_on_id":"rch-mac-axz.18","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.2","title":"Source bundling and canonicalization","description":"Implement deterministic source bundling per PLAN.md normative rules. Create canonical tar archive (PAX recommended) with: sorted file paths (lexicographic, UTF-8), normalized mtimes (epoch 0), normalized uid/gid (0), stable file modes (preserve executable bit, normalize others), fixed pax headers (no host-dependent extended attributes). Exclude by default: .git/, .DS_Store, DerivedData/, .build/, **/*.xcresult/, **/.swiftpm/, host-local RCH artifact directories. Include .rch/xcode.toml in bundle. Support .rchignore file for additional excludes. Symlink handling: reject symlinks escaping repo root (failure_kind=BUNDLER), choose preserve-symlink or dereference-within-root deterministically per config. Compute source_sha256 as SHA-256 of canonical (pre-compression) tar bytes. Bundle modes: worktree (default, tracked + untracked minus excluded) or git_index (only git-index tracked files plus .rch/xcode.toml and ignore file). Emit source_manifest.json (run-scoped) with: schema_version, schema_id (rch-xcode/source_manifest@1), created_at, run_id, source_sha256, entries[] (each with path, size, sha256, type [file|symlink|directory], and symlink_target when applicable). If canonicalization fails, reject with failure_kind=BUNDLER. Transport: may compress with zstd for transfer, but source_sha256 is always over uncompressed canonical tar.","acceptance_criteria":"- Canonical tar archive produces identical source_sha256 for identical repo content across macOS and Linux\n- PAX format with sorted paths, mtime=0, uid/gid=0, stable modes\n- Default excludes applied: .git/, .DS_Store, DerivedData/, .build/, *.xcresult/, .swiftpm/\n- .rch/xcode.toml included in bundle\n- .rchignore file honored for additional excludes\n- Symlinks escaping repo root rejected with failure_kind=BUNDLER\n- source_manifest.json emitted with schema_version, schema_id (rch-xcode/source_manifest@1), entries[] with path, size, sha256, type, symlink_target\n- source_sha256 computed over pre-compression canonical tar bytes\n- worktree and git_index bundle modes both functional\n- Canonicalization failure rejects with failure_kind=BUNDLER","notes":"\n## Error handling and recovery\n\n### Disk full during tar creation\n- ENOSPC: clean up partial tar, fail with failure_kind=BUNDLER, failure_subkind=DISK_FULL.\n- SHOULD estimate required space (2x source size) before starting.\n\n### Interrupted bundling\n- Writes to temp file then renames. Interrupted = orphaned temp. Host cleans up temps on startup.\n\n### File access errors\n- Permission denied or disappeared file: fail with failure_kind=BUNDLER, human_summary with file path.\n- Do NOT silently skip unreadable files (changes source_sha256 unpredictably).\n\n### Large file handling\n- source_sha256 MUST use streaming hash (not load entire tar into memory).\n\n### git_index mode edge cases\n- Missing .git directory: fail with clear diagnostic.\n- Locked git index (concurrent git op): fail, suggest retrying.","status":"closed","priority":1,"issue_type":"task","assignee":"EmeraldHeron","created_at":"2026-02-10T22:21:13.398972387Z","created_by":"root","updated_at":"2026-02-11T13:00:30.403934874Z","closed_at":"2026-02-11T13:00:30.403682625Z","dependencies":[{"issue_id":"rch-mac-axz.2","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.2","depends_on_id":"rch-mac-n4q.2","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.20","title":"Timeout enforcement (overall, idle, connect)","description":"Implement timeout enforcement on the HOST side (all timeout enforcement is host-driven; the worker has no independent timeout watchdog).\n\n## Timeout defaults and bounds\n- `overall_seconds`: max wall-clock time per job. Default: 1800 (30 min). Must be \u003e0 and \u003c=86400.\n- `idle_log_seconds`: max time without new log output. Default: 300 (5 min). Must be \u003e0 and \u003c=overall_seconds.\n- `connect_timeout_seconds`: SSH connection timeout. Default: 30. Must be \u003e0 and \u003c=300.\n- Out-of-bounds values: reject config before run execution with diagnostic (validated by axz.1 config merge).\n\n## Enforcement mechanism\n- `connect_timeout_seconds`: passed to SSH connection in RPC client (axz.8).\n- `overall_seconds`: host starts a wall-clock timer on job submit. If exceeded, host sends cancel RPC (axz.8) with `reason=TIMEOUT_OVERALL`. Worker (axz.14) writes summary.json with failure_subkind=TIMEOUT_OVERALL.\n- `idle_log_seconds`: host tracks last activity timestamp during log streaming (axz.13 tail loop). Activity = new log bytes OR new events. If idle_log_seconds exceeded without activity, host sends cancel RPC with `reason=TIMEOUT_IDLE`. Worker writes summary.json with failure_subkind=TIMEOUT_IDLE.\n\n## Integration points\n- Config validation: axz.1 (rejects out-of-bounds values before run)\n- SSH connect timeout: axz.8 (RPC client applies connect_timeout_seconds)\n- Log streaming activity tracking: axz.13 (tail loop reports last activity time)\n- Cancel dispatch: axz.14 via axz.8 (cancel RPC with reason field)\n- Failure taxonomy: axz.18 (TIMEOUT_OVERALL and TIMEOUT_IDLE are failure_subkinds, exit code remains per failure_kind)\n\n## Exit code on timeout\nTimeout-cancelled jobs use exit_code=80 (CANCELLED) with failure_kind=CANCELLED and failure_subkind=TIMEOUT_OVERALL or TIMEOUT_IDLE. The subkind distinguishes timeout from user-initiated cancellation.\n","acceptance_criteria":"- Config validation rejects out-of-bounds values before run execution\n- overall_seconds: default 1800, range (0, 86400]\n- idle_log_seconds: default 300, range (0, overall_seconds]\n- connect_timeout_seconds: default 30, range (0, 300]\n- Host sends cancel on overall timeout with failure_subkind=TIMEOUT_OVERALL\n- Host sends cancel on idle timeout with failure_subkind=TIMEOUT_IDLE\n- Connect timeout enforced on SSH connection establishment","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:27.251102123Z","created_by":"root","updated_at":"2026-02-11T07:41:25.906293429Z","dependencies":[{"issue_id":"rch-mac-axz.20","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.20","depends_on_id":"rch-mac-axz.10","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.20","depends_on_id":"rch-mac-axz.13","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.20","depends_on_id":"rch-mac-axz.8","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.21","title":"Toolchain resolution and toolchain.json","description":"Implement toolchain resolution on the host: match required Xcode version/build from config against worker capabilities.json Xcode array. If multiple match, prefer exact build number match. If no exact build, prefer highest matching version and log warning. If none match, fail with WORKER_INCOMPATIBLE (exit code 91).\n\n## Host-side responsibilities (this bead)\n- Resolve toolchain identity from config requirements + worker capabilities.json\n- Record resolved toolchain fields in `job_key_inputs.toolchain`: `xcode_build`, `developer_dir`, `macos_version`, `macos_build`, `arch`\n- Populate `job.json` with resolved toolchain data so the worker can emit `toolchain.json` and set `DEVELOPER_DIR`\n\n## What this bead does NOT do\n- Does NOT emit toolchain.json as a file — that is the worker executor (axz.10), which reads the resolved values from job.json\n- Does NOT set DEVELOPER_DIR — the worker executor (axz.10) sets it from job.json at execution time\n\n## Resolution algorithm\n1. Read Xcode constraint from merged config (exact build preferred, version range fallback)\n2. Match against `capabilities.json.xcode_versions[]` array (from probe/cache via axz.7/sai.3)\n3. Exact `build` match → use that entry\n4. No exact build, version match → use highest matching version, log warning\n5. No match → fail with `failure_kind=WORKER_INCOMPATIBLE`\n6. Record `xcode_version`, `xcode_build`, `developer_dir` from the matched entry\n7. Record `macos_version`, `macos_build`, `arch` from the same capabilities snapshot\n","acceptance_criteria":"- Exact build match preferred over version match\n- No exact build → highest matching version selected with warning logged\n- No match → failure_kind=WORKER_INCOMPATIBLE (exit code 91)\n- Resolved toolchain fields recorded in job_key_inputs.toolchain: xcode_build, developer_dir, macos_version, macos_build, arch\n- job.json populated with resolved toolchain data for worker to emit toolchain.json and set DEVELOPER_DIR\n- Pure function: (toolchain_constraint, capabilities_snapshot) → resolved toolchain entry or error","notes":"## Testability requirements\n\n### Pure function design\nToolchain resolution MUST be a pure function:\nInput: (toolchain_constraint from config, capabilities.json xcode_versions array)\nOutput: resolved toolchain entry (version, build, developer_dir, macos_version, macos_build, arch) OR WORKER_INCOMPATIBLE error\n\nNo I/O needed. Unit tests in axz.24 test #11 cover the pure resolution logic.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:28.024477272Z","created_by":"root","updated_at":"2026-02-11T14:02:23.448530024Z","closed_at":"2026-02-11T14:02:23.448400473Z","close_reason":"Implemented toolchain resolution module with ToolchainIdentity struct (5 required fields: xcode_build, developer_dir, macos_version, macos_build, arch), XcodeConstraint for config requirements, resolve_toolchain() algorithm per PLAN.md (exact build → version → min_version → active/highest), toolchain_key() for filesystem-safe cache keys, and 13 unit tests.","dependencies":[{"issue_id":"rch-mac-axz.21","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.21","depends_on_id":"rch-mac-sai.3","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.22","title":"Executor environment audit (executor_env.json)","description":"Worker should emit executor_env.json per job: schema_version (1), schema_id (rch-xcode/executor_env@1), created_at, run_id, job_id, job_key, passed_keys[] (env var keys passed to backend, no values), dropped_keys[] (keys present in worker env but not passed), overrides[] (keys worker set explicitly, e.g. DEVELOPER_DIR). Values must not be recorded by default (opt-in only, redacted by default). Recommended artifact for security auditing.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:28.824425752Z","created_by":"root","updated_at":"2026-02-11T07:57:16.418902088Z","dependencies":[{"issue_id":"rch-mac-axz.22","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.22","depends_on_id":"rch-mac-axz.10","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.23","title":"M2 tests: integration tests (end-to-end flows via mock worker)","description":"Integration tests for M2 using the mock worker. Each test exercises a complete or partial pipeline flow.\n\n**Test cases:**\n\n1. **Full verify cycle (happy path):**\n   - Setup: repo config with build+test actions, mock worker accepting all ops\n   - Input: `rch xcode verify`\n   - Expected: classify both actions → bundle source → submit build job → poll to success → submit test job → poll to success → emit run_summary.json\n   - Pass: exit code 0, run_summary.json has `status=success`, `steps_succeeded=2`, both step directories contain summary.json+job_state.json+job_index.json\n\n2. **Single action run:**\n   - Input: `rch xcode run --action build`\n   - Expected: single-step run, run_plan.json has 1 step\n   - Pass: exit code 0, only one step directory\n\n3. **Cancellation flow:**\n   - Input: `rch xcode verify`, send cancel after build completes but before test starts\n   - Expected: build step SUCCEEDED, test step CANCELLED or skipped\n   - Pass: run_summary.json `status=cancelled`, `exit_code=80`\n\n4. **Signal handling (SIGINT):**\n   - Input: `rch xcode verify`, send SIGINT during RUNNING job\n   - Expected: host sends cancel RPC, waits up to 10s grace, persists run_state.json with `state=CANCELLED`, exits with code 80\n   - Pass: cancel RPC sent, run_state.json persisted, exit code 80\n\n5. **Double SIGINT (immediate exit):**\n   - Send SIGINT, then second SIGINT within grace period\n   - Expected: host exits immediately, still persists run_state.json, cancel RPCs fire-and-forget\n   - Pass: run_state.json exists with `state=CANCELLED`, exit code 80\n\n6. **Retry on SSH failure:**\n   - Mock: first 2 SSH connections fail, 3rd succeeds\n   - Expected: host retries with exponential backoff (initial 2s, max 30s), succeeds on 3rd attempt\n   - Pass: job completes, 3 connection attempts logged\n\n7. **Retry on SOURCE_MISSING:**\n   - Mock: has_source returns true, submit returns SOURCE_MISSING (simulating TOCTOU race with GC)\n   - Expected: host re-uploads bundle via upload_source, retries submit once, succeeds\n   - Pass: job completes, re-upload logged\n\n8. **WORKER_BUSY with retry:**\n   - Mock: first submit returns BUSY with retry_after_seconds=2\n   - Expected: host waits ≥2s, retries, succeeds\n   - Pass: job completes, wait duration ≥2s, max 3 retries before giving up\n\n9. **Sequential step execution with abort-on-failure:**\n   - Setup: verify with build+test, build fails (exit_code=50)\n   - Expected: test step skipped, run_summary.json has `steps_failed=1`, `steps_skipped=1`\n   - Pass: exit code 50 (first failing step), no test artifacts directory\n\n10. **continue_on_failure mode:**\n    - Setup: config `run.continue_on_failure=true`, build fails\n    - Expected: test step still executes\n    - Pass: run_summary.json has `steps_failed≥1`, test step has artifacts\n\n11. **Rejected step handling:**\n    - Setup: classifier rejects test action (bad destination) but accepts build\n    - Expected: build executes, test step in run_plan.json with `rejected: true`, test summary.json has `status=rejected` and `job_key=null`, NO test job_state.json\n    - Pass: run exit_code=10 (rejected), test directory has summary.json but no job_state.json\n\n12. **Run state machine transitions:**\n    - Verify run_state.json transitions: QUEUED → RUNNING → SUCCEEDED (happy path)\n    - Verify `current_step` field updates correctly during execution\n    - Verify `seq` is monotonically increasing\n    - Pass: each state written atomically (write-then-rename)\n\n13. **run_plan.json correctness:**\n    - Verify: `schema_version=1`, `schema_id=\"rch-xcode/run_plan@1\"`, `steps` array matches actions, `selected_worker` populated, `protocol_version` recorded, `continue_on_failure` persisted from config\n    - Pass: all fields present with correct types\n\n14. **run_summary.json exit code aggregation:**\n    - Test each aggregation rule:\n      - Any rejected → run status=rejected, exit_code=10\n      - Any cancelled (no rejected) → run status=cancelled, exit_code=80\n      - Any failed (no rejected/cancelled) → run status=failed, exit_code=first failing step's code\n      - All success → run status=success, exit_code=0\n    - Pass: 4 scenarios with explicit expected exit codes\n\n15. **Clock skew warning:**\n    - Mock: worker probe response timestamp differs from host clock by \u003e30s\n    - Expected: host logs WARNING about clock skew\n    - Pass: warning message present in output mentioning clock difference\n\n16. **Destination resolution against capabilities:**\n    - Setup: config says `OS=latest`, worker capabilities has iOS 19.2 as highest\n    - Expected: destination resolved to concrete `os_version=19.2` with sim_runtime_identifier and sim_runtime_build\n    - Pass: destination.json has resolved values, no \"latest\" in any field\n\n17. **Toolchain resolution:**\n    - Setup: config requires Xcode build `16C5032a`, worker has it\n    - Expected: toolchain.json emitted with matching build, DEVELOPER_DIR set\n    - Pass: toolchain.json fields match worker capability entry\n\n18. **Bundle size enforcement:**\n    - Setup: `bundle.max_bytes=1024`, source exceeds limit\n    - Expected: host rejects before upload with `failure_kind=BUNDLER`, `failure_subkind=SIZE_EXCEEDED`\n    - Also test: worker `max_upload_bytes` \u003c bundle size → same rejection\n    - Pass: no upload attempted, clear error\n\n**Pass/fail:** Each test has explicit expected artifacts, exit codes, and state. Integration tests use mock worker with controllable behavior. Tests MUST NOT require a live macOS worker.\n\n**Logging:** Host MUST log at INFO: pipeline stage transitions (classifying → bundling → submitting → polling → fetching). At WARN: retries, clock skew. Tests verify stage transition log messages for happy path.\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:29.622118769Z","created_by":"root","updated_at":"2026-02-11T07:18:21.950852407Z","dependencies":[{"issue_id":"rch-mac-axz.23","depends_on_id":"rch-mac-666.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.23","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.23","depends_on_id":"rch-mac-axz.17","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.24","title":"M2 tests: unit tests (config merge, JobSpec, identifiers, timeouts)","description":"Unit tests for M2 core components. No mock worker needed — these test pure functions.\n\n**Test cases:**\n\n1. **Configuration merge:**\n   - Deep merge: `{a: {b: 1}}` + `{a: {c: 2}}` → `{a: {b: 1, c: 2}}`\n   - Array replace (NOT concatenate): `{tags: [a]}` + `{tags: [b]}` → `{tags: [b]}`\n   - Scalar override: `{timeout: 30}` + `{timeout: 60}` → `{timeout: 60}`\n   - Precedence order: built-in \u003c host config \u003c repo config \u003c CLI flags\n   - Determinism: same inputs in any merge order → identical output\n   - Pass: merged object matches expected fixture for each case\n\n2. **effective_config.json emission:**\n   - Verify: `schema_version`, `created_at`, `run_id`, `job_id`, `job_key` present\n   - Verify: `contributing_sources[]` includes origin + file path + raw bytes digest\n   - Verify: secrets redacted (inject a field named `password` or `token`) → replaced with `[REDACTED]`, listed in `redactions[]`\n   - Pass: all fields present, secrets absent from output\n\n3. **JobSpec determinism:**\n   - Input: identical source + config + argv\n   - Expected: identical `job_key` (SHA-256 of JCS of job_key_inputs)\n   - Verify: reordering keys in job_key_inputs produces same JCS bytes (RFC 8785 property)\n   - Verify: job_key_inputs includes source_sha256, sanitized_argv, toolchain (xcode_build, developer_dir, macos_version, macos_build, arch), destination (platform, name, os_version, provisioning + sim fields for simulators)\n   - Verify: job_key_inputs does NOT include timeouts, worker SSH details, cache toggles, backend selection\n   - Pass: byte-identical job_key across runs; excluded fields don't affect key\n\n4. **Identifier format validation:**\n   - Valid: `A1234567890` (11 chars), `run-2026-01-15T09-32-00Z_abc` → pass regex `^[A-Za-z0-9][A-Za-z0-9_-]{9,63}$`\n   - Invalid: `a` (too short), contains `/`, contains `\\`, contains whitespace, contains `..`, starts with `-`, 65+ chars\n   - Pass: valid IDs accepted, invalid IDs rejected with descriptive error\n\n5. **Timestamp conventions:**\n   - All timestamps in emitted JSON MUST be RFC 3339 with `Z` suffix\n   - Test: parse and re-emit known timestamps, verify format\n   - Pass: no non-UTC timestamps in any artifact\n\n6. **Timeout bounds validation:**\n   - `overall_seconds=0` → rejected (must be \u003e 0)\n   - `overall_seconds=86401` → rejected (must be ≤ 86400)\n   - `idle_log_seconds \u003e overall_seconds` → rejected\n   - `connect_timeout_seconds=0` → rejected\n   - `connect_timeout_seconds=301` → rejected (must be ≤ 300)\n   - Valid values within bounds → accepted\n   - Pass: out-of-bounds values produce diagnostic error before run starts\n\n7. **Job state machine transitions:**\n   - Valid: QUEUED→RUNNING, RUNNING→SUCCEEDED, RUNNING→FAILED, RUNNING→CANCELLED, RUNNING→CANCEL_REQUESTED→CANCELLED\n   - Invalid: QUEUED→SUCCEEDED (skip RUNNING), SUCCEEDED→RUNNING (backward)\n   - Pass: valid transitions succeed, invalid transitions raise error\n   - Verify `seq` increments on each transition, `updated_at` changes\n\n8. **Run state machine transitions:**\n   - Valid: QUEUED→RUNNING→SUCCEEDED, QUEUED→RUNNING→FAILED, QUEUED→RUNNING→CANCELLED\n   - Invalid: QUEUED→SUCCEEDED (skip RUNNING)\n   - Pass: same as job state machine tests\n\n9. **Failure taxonomy and exit code mapping:**\n   - Each failure_kind maps to exactly one exit_code: CLASSIFIER_REJECTED→10, SSH→20, TRANSFER→30, EXECUTOR→40, XCODEBUILD→50, MCP→60, ARTIFACTS→70, CANCELLED→80, WORKER_BUSY→90, WORKER_INCOMPATIBLE→91, BUNDLER→92, ATTESTATION→93\n   - Verify: failure_kind→exit_code mapping is a total function (no unmapped kinds)\n   - Verify: status field restricted to {success, failed, rejected, cancelled}\n   - Verify: rejected status implies failure_kind=CLASSIFIER_REJECTED, cancelled implies CANCELLED\n   - Pass: all 12 failure_kinds produce correct exit codes, all 4 statuses valid\n\n10. **Run-level exit code aggregation:**\n    - Input: list of step results with varying statuses\n    - Any rejected → run status=rejected, exit_code=10\n    - Any cancelled (no rejected) → run status=cancelled, exit_code=80\n    - Any failed (no rejected/cancelled) → run status=failed, exit_code=first failing step's code\n    - All success → run status=success, exit_code=0\n    - Pass: 4+ scenarios with explicit expected exit codes (pure function, no I/O)\n\n11. **Toolchain resolution (pure logic):**\n    - Exact build match: config requires `16C5032a`, capabilities has it → selected\n    - Version fallback: config requires Xcode 16.2, capabilities has 16.2 (build A) and 16.2 (build B) → highest build selected, warning logged\n    - No match: config requires `99A999`, capabilities lacks it → WORKER_INCOMPATIBLE error\n    - Multiple versions: capabilities has Xcode 16.1, 16.2, 16.3; config requires `\u003e=16.2` → highest matching selected\n    - Pass: each case returns expected toolchain entry or specific error\n\n12. **Destination resolution (pure logic):**\n    - OS=latest: capabilities has iOS 18.0, 19.1, 19.2 → resolves to 19.2\n    - Exact version: config says `os_version=19.1` → resolves to 19.1 if present, WORKER_INCOMPATIBLE if not\n    - Simulator fields: resolved destination includes sim_runtime_identifier, sim_runtime_build, device_type_identifier\n    - No matching device: config requests `iPhone 99` → WORKER_INCOMPATIBLE\n    - Platform mismatch: config requests `tvOS Simulator`, worker has only iOS → WORKER_INCOMPATIBLE\n    - Pass: each case returns correct resolved destination or specific error; resolved os_version is NEVER \"latest\"\n\n13. **Worker selection determinism (pure logic):**\n    - 3 workers: A (priority=1), B (priority=2), C (priority=1, name after A alphabetically) → A selected\n    - Same inputs 10x → same result every time\n    - Worker with missing required Xcode filtered out before sorting\n    - Worker with missing required destination filtered out\n    - All workers filtered out → specific WORKER_INCOMPATIBLE error distinguishing \"no tags\" vs \"no Xcode/destination\"\n    - Pass: deterministic selection, correct filtering, descriptive errors\n\n14. **Environment variable allowlist (pure logic):**\n    - Input env: {HOME, PATH, TMPDIR, DEVELOPER_DIR, LANG, LC_ALL, AWS_SECRET_KEY, DATABASE_URL}\n    - Allowed through: {HOME, PATH, TMPDIR, DEVELOPER_DIR, LANG, LC_ALL}\n    - Dropped: {AWS_SECRET_KEY, DATABASE_URL}\n    - Pass: only allowed keys in output, dropped keys listed for diagnostics\n\n**Pass/fail:** Pure function tests with known inputs → known outputs. No I/O dependencies. Determinism tests run same input 3x and compare.\n\n**Logging:** Not applicable for pure unit tests. Config merge should log at DEBUG the merge steps (which source overrode which field).\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-11T07:18:49.026415419Z","created_by":"root","updated_at":"2026-02-11T16:21:42.459357213Z","closed_at":"2026-02-11T16:21:42.459004688Z","close_reason":"M2 unit tests substantially complete with 337+ passing tests covering: config merge (7), effective_config (10), JobSpec/job_key (9), identifier validation (4), timeout validation (2), job state machine (13+), run state machine (13), failure taxonomy (25), toolchain resolution (15), destination resolution (18), worker selection (13). Env var allowlist test deferred to axz.10 (worker executor).","dependencies":[{"issue_id":"rch-mac-axz.24","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.24","depends_on_id":"rch-mac-axz.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.24","depends_on_id":"rch-mac-axz.11","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.24","depends_on_id":"rch-mac-axz.5","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.25","title":"M2 tests: source bundling and canonicalization","description":"Tests for source bundle canonicalization. These verify deterministic tar creation and integrity.\n\n**Test cases:**\n\n1. **Deterministic tar (same input → same sha256):**\n   - Create identical repo content twice (different timestamps, different file creation order)\n   - Bundle both → source_sha256 MUST be identical\n   - Pass: byte-identical tar output, identical sha256\n\n2. **Canonical tar properties:**\n   - Verify: file paths sorted lexicographically (UTF-8)\n   - Verify: mtimes normalized to 0\n   - Verify: uid/gid normalized to 0\n   - Verify: file modes preserve executable bit, normalize others\n   - Verify: PAX format used\n   - Pass: extract tar metadata, check each property\n\n3. **Default exclusions:**\n   - Repo contains `.git/`, `.DS_Store`, `DerivedData/`, `.build/`, `foo.xcresult/`, `.swiftpm/`\n   - None of these appear in the bundle\n   - `.rch/xcode.toml` IS included\n   - Pass: excluded paths absent, config present\n\n4. **.rchignore support:**\n   - `.rchignore` contains `*.log` and `tmp/`\n   - Bundle excludes matching files\n   - Pass: no .log files or tmp/ in bundle entries\n\n5. **Symlink handling — escape rejection:**\n   - Symlink points to `../../etc/passwd` (escapes repo root)\n   - Expected: bundle fails with `failure_kind=BUNDLER`\n   - Pass: clear error, no bundle created\n\n6. **Symlink handling — safe symlinks:**\n   - Symlink points to sibling file within repo\n   - Expected: handled per config (preserve or dereference), deterministic choice\n   - Pass: bundle succeeds, source_manifest.json records symlink with `type=symlink` and `symlink_target`\n\n7. **source_manifest.json emission:**\n   - Verify: `schema_version`, `schema_id=\"rch-xcode/source_manifest@1\"`, `created_at`, `run_id`, `source_sha256`\n   - Verify: `entries[]` each has `path`, `size`, `sha256`, `type` (file|symlink|directory)\n   - Verify: entries sorted by path\n   - Pass: all fields present, types correct, entries match bundle content\n\n8. **Bundle modes:**\n   - `worktree` mode: includes tracked + untracked (except excluded)\n   - `git_index` mode: includes only tracked files + `.rch/xcode.toml`\n   - Pass: untracked file present in worktree bundle, absent in git_index bundle\n\n9. **Bundle size enforcement:**\n   - `bundle.max_bytes=100`, repo content exceeds 100 bytes\n   - Expected: rejected with `failure_kind=BUNDLER`, `failure_subkind=SIZE_EXCEEDED`\n   - Pass: rejection before any upload, error message includes size and limit\n\n10. **Cross-platform reproducibility (if CI has both Linux + macOS):**\n    - Same repo content bundled on Linux and macOS\n    - Expected: identical source_sha256\n    - Pass: sha256 matches across platforms\n\n11. **source_sha256 computed over pre-compression bytes:**\n    - Bundle with compression=zstd for transfer\n    - Verify source_sha256 is hash of canonical tar, NOT of compressed bytes\n    - Pass: source_sha256 matches hash of uncompressed tar\n\n**Pass/fail:** Each test uses fixture repos with known content. sha256 values are pre-computed golden values where applicable. Tests run without a live worker.\n\n**Logging:** Bundler MUST log at INFO: bundle size, entry count, source_sha256. At DEBUG: each excluded path (with exclusion reason). At WARN: symlink decisions. Tests verify log contains source_sha256 and entry count.\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T07:19:12.867161864Z","created_by":"root","updated_at":"2026-02-11T07:19:12.867161864Z","dependencies":[{"issue_id":"rch-mac-axz.25","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.25","depends_on_id":"rch-mac-axz.2","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.26","title":"M2 tests: worker executor unit tests","description":"Unit tests for worker executor logic (axz.10) using mocked dependencies. No macOS/Xcode required.\n\n**Test cases:**\n\n1. **xcodebuild command construction:**\n   - Input: job.json with action=build, sanitized_argv=[\"build\", \"-scheme\", \"Foo\", \"-workspace\", \"Bar.xcworkspace\"]\n   - Expected: xcodebuild invoked with exactly sanitized_argv (action NOT prepended again)\n   - Pass: no duplicate action, no extra flags\n\n2. **-resultBundlePath injection for test jobs:**\n   - action=test → -resultBundlePath appended; action=build → not appended\n   - Pass: test jobs get resultBundlePath, build jobs do not\n\n3. **-derivedDataPath per cache mode:**\n   - per_job → job-specific path; shared → shared cache path; off → no flag\n   - Pass: correct path per mode\n\n4. **Exit code mapping (xcodebuild → summary):**\n   - exit 0 → success/0; exit 65 → failed/XCODEBUILD/50/backend_exit_code=65; SIGKILL → failed/50/backend_term_signal=SIGKILL; fail to start → EXECUTOR/40/null\n   - Pass: all mappings correct (pure function)\n\n5. **Working directory isolation:**\n   - job_id=J1 → \u003cjobs_root\u003e/J1/work/; job_id=J2 → \u003cjobs_root\u003e/J2/work/\n   - Pass: deterministic, non-overlapping\n\n6. **summary.json field completeness:**\n   - Verify ALL normative fields present with correct types\n   - Pass: no missing fields\n\n7. **toolchain.json and destination.json emission:**\n   - Given job.json with resolved values → verify emitted files match schemas\n   - Pass: all fields present\n\n8. **Cancellation signal sequence (mock ProcessLauncher):**\n   - SIGTERM first, grace period, then SIGKILL if needed\n   - Pass: correct sequence observed\n\n9. **Artifact atomic writes (mock FileSystem):**\n   - All writes use write-then-rename\n   - Pass: mock records rename calls\n\n10. **Source extraction failure:**\n    - Mock tar extraction fails → summary with failure_kind=TRANSFER, failure_subkind=EXTRACTION_FAILED\n    - Pass: error propagated, cleanup performed\n\n**Pass/fail:** All tests use mock ProcessLauncher, mock FileSystem, mock Clock. No macOS, no Xcode needed.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-11T07:53:00.338167777Z","created_by":"root","updated_at":"2026-02-11T07:53:00.338167777Z","dependencies":[{"issue_id":"rch-mac-axz.26","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.26","depends_on_id":"rch-mac-axz.10","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.3","title":"Bundle size enforcement","description":"Enforce bundle size limits before upload. If bundle.max_bytes \u003e 0 in config, reject bundle before upload if it exceeds the limit (failure_kind=BUNDLER, failure_subkind=SIZE_EXCEEDED). If worker capabilities.json includes max_upload_bytes, also check against that. Effective limit is min(bundle.max_bytes, worker.max_upload_bytes) where 0 means no limit from that source. Worker must also reject upload_source if content_length exceeds max_upload_bytes, returning PAYLOAD_TOO_LARGE with data.max_bytes.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-10T22:21:14.220600129Z","created_by":"root","updated_at":"2026-02-10T22:21:14.220600129Z","dependencies":[{"issue_id":"rch-mac-axz.3","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.3","depends_on_id":"rch-mac-axz.2","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.4","title":"Destination resolver","description":"Implement destination resolution on the host: resolve destination constraints from config (e.g. OS=latest, platform=iOS Simulator) against worker capabilities.json snapshot. Map abstract constraints to concrete values: resolve OS=latest to specific version, find matching simulator runtime identifiers and build strings, find matching device type identifiers.\n\n## Host-side responsibilities (this bead)\n- Resolve destination constraints against worker capabilities.json (from probe/cache via axz.7/sai.3)\n- Record resolved destination in job_key_inputs.destination: platform, name, os_version (concrete, MUST NOT be \"latest\"), provisioning (\"existing\" for MVP)\n- For iOS/tvOS/watchOS Simulator: also include sim_runtime_identifier, sim_runtime_build, device_type_identifier\n- Record original_constraint (raw destination string from config) in job.json for the worker to include in destination.json\n- Validate destination availability on selected worker — fail with WORKER_INCOMPATIBLE if no matching destination found\n\n## What this bead does NOT do\n- Does NOT emit destination.json as a file — that is the worker executor (axz.10), which reads resolved values from job.json and writes the artifact file\n- Does NOT handle ephemeral simulator provisioning — that is M7 (b7s.2)\n","acceptance_criteria":"- OS=latest resolved to concrete version from worker capabilities\n- Simulator destinations include sim_runtime_identifier, sim_runtime_build, device_type_identifier\n- Missing destination on worker fails with failure_kind=WORKER_INCOMPATIBLE\n- original_constraint preserved in job.json for worker to include in destination.json\n- Resolved os_version is NEVER \"latest\"\n- provisioning defaults to \"existing\" for MVP\n- Pure function: (destination_constraint, capabilities_snapshot) → resolved destination or error","notes":"## Testability requirements\n\n### Pure function design\nDestination resolution MUST be a pure function:\nInput: (destination_constraint from config, capabilities.json snapshot)\nOutput: resolved destination object OR WORKER_INCOMPATIBLE error\n\nNo I/O, no network, no worker communication. The capabilities snapshot is already fetched by axz.7/sai.3. Unit tests in axz.24 test #12 cover the pure resolution logic with fixture capabilities snapshots.\n\n### Mockable capabilities\nTests provide fixture capabilities.json with known runtimes/devices. No real simctl needed.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:14.94063914Z","created_by":"root","updated_at":"2026-02-11T15:24:34.905154935Z","closed_at":"2026-02-11T15:24:34.905154935Z","close_reason":"Destination resolver complete with 11 passing tests","dependencies":[{"issue_id":"rch-mac-axz.4","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.4","depends_on_id":"rch-mac-sai.3","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.5","title":"JobSpec builder and job_key computation","description":"Implement the JobSpec builder that produces job.json — a fully specified, deterministic step job description with no ambient defaults.\n\n## job.json fields\n- schema_version (1), schema_id (rch-xcode/job@1)\n- run_id, job_id, action (build or test)\n- job_key_inputs (canonical key-object)\n- job_key (SHA-256 hex of JCS(job_key_inputs))\n- effective_config (merged config snapshot from axz.1, including schema envelope, sources, redactions)\n- original_constraint (raw destination string from config, for worker to include in destination.json)\n- created_at (RFC 3339 UTC)\n- optional artifact_profile (minimal or rich, default minimal)\n\n## job_key_inputs fields\n- source_sha256 (from axz.2 source bundling)\n- sanitized_argv (from n4q.3 classifier output — note: includes action as first element per n4q.1 canonical ordering)\n- toolchain: {xcode_build, developer_dir, macos_version, macos_build, arch} (from axz.21 resolution)\n- destination: {platform, name, os_version, provisioning} (from axz.4 resolution), plus sim_runtime_identifier/sim_runtime_build/device_type_identifier for simulators\n\njob_key_inputs MUST NOT include host-only operational settings (timeouts, worker SSH details, cache toggles, worker selection metadata, backend selection).\n\n## job_key computation\nSHA-256 hex digest of RFC 8785 JSON Canonicalization Scheme (JCS) of job_key_inputs.\n\n## Standalone artifacts emitted by this bead (host-side)\n- `job_key_inputs.json`: byte-for-byte identical to the job_key_inputs object embedded in job.json (standalone for inspectability)\n- `invocation.json`: emitted by n4q.3, referenced here for completeness\n\nNote: `job.json` is transmitted to the worker. The worker (axz.10) uses it to emit per-job artifact files (toolchain.json, destination.json, effective_config.json, summary.json, etc).\n\n## Identifier formats\nrun_id, job_id, request_id must be opaque but filesystem-safe: match ^[A-Za-z0-9][A-Za-z0-9_-]{9,63}$. Generate using ULID or UUIDv7 (sortable). job_id must be globally unique per host over time.\n","acceptance_criteria":"- job.json emitted with all normative fields per PLAN.md JobSpec schema (schema_version=1, schema_id=rch-xcode/job@1, run_id, job_id, action, job_key_inputs, job_key, effective_config, created_at)\n- job_key = SHA-256 hex of RFC 8785 JCS of job_key_inputs (verified by independent implementation)\n- job_key_inputs includes: source_sha256, sanitized_argv, toolchain (xcode_build, developer_dir, macos_version, macos_build, arch), destination (platform, name, os_version, provisioning, plus sim fields for simulators)\n- job_key_inputs excludes: timeouts, worker SSH details, cache toggles, worker selection metadata, backend selection\n- Standalone job_key_inputs.json emitted byte-for-byte identical to embedded object\n- Identifiers match regex ^[A-Za-z0-9][A-Za-z0-9_-]{9,63}$ and are filesystem-safe\n- run_id and job_id generated as ULID or UUIDv7 (sortable)\n- job_id globally unique per host over time\n- Identical inputs produce identical job_key (determinism test)","status":"closed","priority":0,"issue_type":"task","created_at":"2026-02-10T22:21:15.726128313Z","created_by":"root","updated_at":"2026-02-11T15:30:45.136957486Z","closed_at":"2026-02-11T15:30:45.1367014Z","close_reason":"JobSpec builder complete","dependencies":[{"issue_id":"rch-mac-axz.5","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.5","depends_on_id":"rch-mac-axz.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.5","depends_on_id":"rch-mac-axz.2","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.5","depends_on_id":"rch-mac-axz.21","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.5","depends_on_id":"rch-mac-axz.4","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.5","depends_on_id":"rch-mac-n4q.3","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.6","title":"Run builder and run_plan.json","description":"Implement the run builder: resolves repo verify actions into an ordered run plan. For rch xcode verify: read verify actions from .rch/xcode.toml, run classifier on each, allocate stable job_ids, choose a worker once (all steps go to same worker). For rch xcode run --action \u003caction\u003e: single-step run. Emit run_plan.json at \u003crun_id\u003e/run_plan.json before starting execution. run_plan.json must include: schema_version, schema_id (rch-xcode/run_plan@1), created_at, run_id, steps (ordered array of {index, action, job_id, rejected}), selected_worker, selected_worker_host, continue_on_failure (bool from config), protocol_version (negotiated). If classifier rejects a step, it still appears in run_plan.json with rejected: true. Rejected steps get a job_id for artifact paths but are never submitted to worker. Rejected steps must have summary.json with status=rejected at \u003crun_id\u003e/steps/\u003caction\u003e/\u003cjob_id\u003e/summary.json, but NO job_state.json. For rejected steps, job_key must be null in summary.json. Sequential execution: if a step fails or is rejected, skip subsequent steps (unless continue_on_failure=true). Skipped steps recorded in run_summary.json under steps_skipped.","acceptance_criteria":"- run_plan.json emitted at \u003crun_id\u003e/run_plan.json before execution starts\n- Includes all normative fields: schema_version, schema_id (rch-xcode/run_plan@1), created_at, run_id, steps[], selected_worker, selected_worker_host, continue_on_failure, protocol_version\n- verify command: reads .rch/xcode.toml verify actions, classifies each, populates steps[]\n- run command: single-step run plan\n- Rejected steps appear with rejected: true and get summary.json with status=rejected, job_key=null, but NO job_state.json\n- Sequential execution: step failure skips subsequent steps (unless continue_on_failure=true)\n- Skipped steps counted in run_summary.json steps_skipped\n- All steps use the same worker (chosen once)","notes":"\n## Error handling and recovery\n\n### Crash after partial plan emission\n- run_plan.json written atomically (write-then-rename). Crash during write = no plan file, run never started.\n- Crash after plan but before jobs: normal resumption handles (all jobs not started).\n\n### Worker unreachable after selection\n- SSH retry (3x) handles transient failures. Permanent unreachable: failure_kind=SSH. No mid-run worker switch.\n\n### Classifier errors\n- Classifier crash (bug): fail entire run with failure_kind=EXECUTOR, no partial plan.\n- Classifier rejection: normal flow, emit plan with rejected: true.\n\n### Empty verify actions\n- Empty actions array: fail with clear diagnostic before plan creation.\n## Rejected step summary.json field naming\nPLAN.md mentions summary.json includes rejection_reason (singular). For rejected steps, summary.json SHOULD include rejection_reasons (array of strings from ClassifierResult.rejection_reasons) to capture all violations. The human_summary field provides a single-line readable summary of the rejection.","status":"closed","priority":0,"issue_type":"task","assignee":"Opus","created_at":"2026-02-10T22:21:16.453112803Z","created_by":"root","updated_at":"2026-02-11T15:32:53.890688714Z","closed_at":"2026-02-11T15:32:53.890592585Z","close_reason":"Implementation complete: RunPlan, RunPlanBuilder, Step structs, single_step_plan/verify_plan functions, atomic file writing, 13 tests passing","dependencies":[{"issue_id":"rch-mac-axz.6","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.6","depends_on_id":"rch-mac-axz.5","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.6","depends_on_id":"rch-mac-axz.7","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.6","depends_on_id":"rch-mac-n4q.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.7","title":"Worker selection algorithm","description":"Implement deterministic worker selection per PLAN.md. Selection algorithm: 1) Filter by required tags (macos, xcode, plus any repo-required). 2) Probe or load cached capabilities.json snapshots (bounded staleness via probe_ttl_seconds). If probe fails, exclude worker from candidates for this run, record {worker, probe_error, probe_duration_ms} in worker_selection.json under probe_failures[]. If ALL probes fail, fail with failure_kind=SSH listing unreachable workers. If cached snapshot is stale AND fresh probe fails, do NOT fall back to stale snapshot. 3) Filter by constraints (destination exists, required Xcode available). 4) Sort deterministically: by explicit worker priority (from host config), then by stable worker name. 5) Choose first. Default mode: deterministic (dynamic metrics like load/disk MUST NOT affect choice). Emit worker_selection.json with: schema_version, schema_id (rch-xcode/worker_selection@1), created_at, run_id, negotiated_protocol_version, worker_protocol_range {min, max}, selected_worker, selected_worker_host, selection_mode, candidate_count, probe_failures[], snapshot_age_seconds, snapshot_source (cached or fresh), plus the capabilities.json snapshot used. Store capabilities.json snapshot at \u003crun_id\u003e/capabilities.json.","acceptance_criteria":"- Deterministic mode: identical inputs always select same worker\n- Filter by tags, then by constraints (Xcode available, destination exists)\n- Sort by priority then stable name; choose first\n- Probe failures recorded in worker_selection.json probe_failures[]\n- All probes fail → failure_kind=SSH with human_summary listing workers\n- Stale cached snapshot + failed fresh probe → do NOT fall back to stale\n- worker_selection.json emitted with all normative fields per PLAN.md schema\n- capabilities.json snapshot stored at \u003crun_id\u003e/capabilities.json","notes":"## Error handling and recovery\n\n### Probe timeout handling\n- Per-probe timeout: connect_timeout_seconds + 30s. Exclude on timeout, record in probe_failures[].\n- Probes to multiple workers SHOULD run concurrently to avoid cumulative delays.\n\n### Capabilities snapshot caching\n- Corrupted cache (invalid JSON): delete, force fresh probe.\n- Cache dir not writable: probe works but no caching. Log warning.\n- Cache writes MUST be atomic (write-then-rename).\n\n### No workers match constraints\n- Fail with WORKER_INCOMPATIBLE. Distinguish \"no workers have required tags\" vs \"no required Xcode/destination\".\n- Include specific missing constraint in human_summary.\n\n## Testability requirements\n\n### Interface isolation\n1. **ProbeClient interface**: abstracts worker probing. Mock returns configurable capabilities per worker (or errors/timeouts). Real implementation uses RPC client (axz.8).\n2. **SnapshotCache interface**: abstracts capabilities caching. Mock uses in-memory map with configurable staleness.\n3. **Clock interface**: for staleness checks.\n\n### The core selection algorithm is a pure function\nInput: list of (worker_name, priority, capabilities_snapshot) + constraints (required_tags, required_xcode, required_destination)\nOutput: selected_worker OR error with specific reason\n\nThis MUST be testable as a pure function with NO I/O. Probe failures and caching are separate concerns wired at the integration level. Unit tests in axz.24 test #13 cover the pure selection logic.\n","status":"closed","priority":1,"issue_type":"task","assignee":"Opus","created_at":"2026-02-10T22:21:17.281261917Z","created_by":"root","updated_at":"2026-02-11T15:29:49.911446682Z","closed_at":"2026-02-11T15:29:49.911340204Z","close_reason":"Implementation complete with 13 passing tests. Core select_worker() algorithm, SelectionConstraints, WorkerSelection artifact, and snapshot validity checking all implemented per PLAN.md spec.","dependencies":[{"issue_id":"rch-mac-axz.7","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.7","depends_on_id":"rch-mac-sai.2","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.7","depends_on_id":"rch-mac-sai.3","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.8","title":"Host RPC client (JSON-over-SSH)","description":"Implement the host-side RPC client for communicating with workers over SSH. Each operation is a single JSON request on stdin → single JSON response on stdout, mapped to SSH forced-command execution.\n\n## Operations\nAll protocol-defined ops: probe, reserve, release, submit, status, tail, cancel, has_source, upload_source, fetch.\n\n## Request/Response handling\n- Request envelope: `{protocol_version: int, op: string, request_id: string, payload: object}`\n- Response envelope: `{protocol_version: int, request_id: string, ok: bool, payload?: object, error?: {code, message, data?}}`\n- `request_id`: generated as ULID or UUIDv7 per RPC call for correlation and retries.\n- `request_id` format MUST match the identifier regex: `^[A-Za-z0-9][A-Za-z0-9_-]{9,63}$` (same as run_id/job_id).\n\n## Cancel payload\nCancel request payload: `{job_id: string, reason?: string}`. Reason values: `USER` (default), `TIMEOUT_OVERALL`, `TIMEOUT_IDLE`, `SIGNAL`. The host sets reason so the worker can propagate appropriate failure_subkind into summary.json. See axz.14 for worker-side handling and axz.20 for timeout-triggered cancellation.\n\n## Binary framing (upload_source)\nJSON header line (compact single-line, no unescaped newlines) terminated by newline, followed by exactly `content_length` raw bytes. Header includes `payload.stream` with: `content_length`, `content_sha256`, `compression` (none|zstd), `format` (tar). Discriminator: if `payload` has `stream` object, use framed format; otherwise entire stdin is single JSON.\n\n## Binary framing (fetch response)\nBinary-framed response: JSON header line IS the complete response (not nested under `payload`). Must include `protocol_version`, `request_id`, `ok: true`, `job_id`, `manifest`, and `stream` object. Host verifies `content_sha256` of received bytes, then verifies manifest integrity per host manifest verification rules (y6s.2).\n\n## Protocol version negotiation\nAfter probe (at protocol_version: 0), select version within intersection of host and worker ranges. Use selected version for all subsequent requests. If no intersection, fail with failure_kind=WORKER_INCOMPATIBLE (exit code 91).\n\n## Timeouts and retries\n- `connect_timeout_seconds`: SSH connection timeout (default 30, from config via axz.1).\n- SSH connect retry: 3x exponential backoff, initial 2s, max 30s.\n- upload_source retry: 3x exponential backoff (idempotent by source_sha256).\n- Executor (submit): NEVER retry automatically (non-idempotent). Retries require a new run.\n- On SOURCE_MISSING response to submit: re-upload source (upload_source) then retry submit once (handles TOCTOU race; see axz.9).\n- On WORKER_BUSY: respect `retry_after_seconds`, bounded retry with exponential backoff (max 3).\n\n## Error mapping\nParse `error.code` from response and map to failure taxonomy (axz.18): BUSY→WORKER_BUSY(90), UNSUPPORTED_PROTOCOL→WORKER_INCOMPATIBLE(91), FEATURE_MISSING→WORKER_INCOMPATIBLE(91), SOURCE_MISSING→re-upload+retry, ARTIFACTS_GONE→ARTIFACTS_FAILED(70), PAYLOAD_TOO_LARGE→BUNDLER(92), LEASE_EXPIRED→re-reserve+retry(once), INVALID_REQUEST→EXECUTOR(40).\n","acceptance_criteria":"- Can execute all RPC ops over SSH: probe, submit, status, tail, cancel, has_source, upload_source, fetch\n- Binary framing correctly implemented: JSON header line + raw bytes for upload_source\n- fetch response correctly parsed: binary-framed response with manifest and streamed tar\n- Protocol version negotiation works: probe at v0, then use negotiated version\n- Connect timeout enforced per connect_timeout_seconds config\n- Retry logic: SSH connect 3x exponential backoff (2s initial, 30s max), upload 3x, executor NEVER\n- request_id generated as unique string per RPC call (ULID/UUIDv7 recommended)\n- Errors parsed from response envelope and mapped to appropriate failure_kind","notes":"## Error handling and recovery\n\n### SSH connection drops mid-transfer\n- upload_source: retry safe (idempotent by source_sha256). Existing 3x retry handles this.\n- fetch: discard partial data, retry, verify content_sha256 on complete download.\n- submit/status/tail/cancel: idempotent by design. Safe to retry (except submit uses job_id idempotency).\n\n### Response parsing failures\n- Not valid JSON: failure_kind=SSH (exit_code=20). Do NOT retry executor ops.\n- Missing required fields: PROTOCOL_ERROR.\n- request_id mismatch: PROTOCOL_ERROR.\n\n### SSH process management\n- SSH subprocesses may orphan if host killed with SIGKILL. Set process group, kill group on signal.\n- SSH SHOULD use ServerAliveInterval=15, ServerAliveCountMax=2 (detect dead connections ~45s).\n\n### Per-RPC timeout\n- Individual RPC calls should have per-call timeout (connect_timeout_seconds + 30s) to prevent infinite hangs.\n\n## Testability requirements\n\n### Interface isolation (MUST for testability)\nThe RPC client MUST be structured with an injectable transport layer:\n1. **Transport interface**: abstracts the SSH connection. Methods: `execute(request) → response` and `executeFramed(request, stream) → response`. Mock implementation connects directly to mock worker (666.1) in-process, bypassing SSH entirely.\n2. **RetryPolicy interface**: abstracts backoff timing. Mock uses zero-delay retries for fast tests. Real implementation uses exponential backoff.\n3. **Clock interface**: for retry delay computation.\n\n### Unit-testable components (no SSH needed)\n- Error code → failure_kind mapping: BUSY→WORKER_BUSY, UNSUPPORTED_PROTOCOL→WORKER_INCOMPATIBLE, etc. (pure function)\n- Retry decision logic: which errors are retryable, which are not (pure function)\n- Request envelope construction: verify protocol_version, op, request_id, payload structure\n- Response envelope parsing: verify ok/error discrimination, field extraction\n- Binary frame header construction/parsing: compact JSON + content_length\n\n### Integration-testable (via mock worker in-process)\nAll RPC ops exercised via mock worker (666.1) as in-process library — no SSH, no network. This is the PRIMARY test path for the RPC client.\n","status":"closed","priority":1,"issue_type":"task","assignee":"Paul Robinshaw","created_at":"2026-02-10T22:21:18.160169484Z","created_by":"root","updated_at":"2026-02-11T13:03:33.462279049Z","closed_at":"2026-02-11T13:03:33.462301601Z","dependencies":[{"issue_id":"rch-mac-axz.8","depends_on_id":"rch-mac-666.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.8","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.8","depends_on_id":"rch-mac-sai.5","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-axz.9","title":"Worker source bundle store (content-addressed)","description":"Implement content-addressed source store on worker, keyed by source_sha256. Operations: has_source (returns {exists: bool}), upload_source (accepts binary-framed upload, verifies content_sha256 of received bytes, then decompresses if needed and verifies canonical bundle digest matches source_sha256). Upload must be atomic by source_sha256 (write-to-temp-then-rename to prevent partial visibility). If bundle already exists when upload completes (concurrent upload), discard duplicate and return success. On submit, if referenced source_sha256 not present, reject with SOURCE_MISSING (not generic failure). On receiving SOURCE_MISSING, host must re-upload and retry submit once (handles TOCTOU race between has_source and submit due to concurrent GC). GC: must not remove bundles referenced by RUNNING jobs. GC policy may align with cache eviction (age/size based).","acceptance_criteria":"- Content-addressed store: bundles stored under \u003cstore_root\u003e/\u003csource_sha256[0:2]\u003e/\u003csource_sha256\u003e/bundle.tar (or similar two-level fan-out)\n- has_source returns {exists: true} when bundle present, {exists: false} otherwise\n- upload_source: verifies content_sha256 of received bytes, decompresses if needed, verifies canonical digest matches source_sha256\n- Upload is atomic: write-to-temp-then-rename prevents partial visibility\n- Concurrent duplicate uploads: second writer discards and returns success\n- submit with missing source_sha256 returns SOURCE_MISSING error code\n- GC does not remove bundles referenced by RUNNING jobs\n- GC supports at least one of: size-based or age-based eviction","notes":"\n## Error handling and recovery\n\n### Disk full during upload\n- If write-to-temp fails with ENOSPC, worker MUST delete the temp file and return error with available disk space in error.data.\n- Temp directory MUST be on the same filesystem as final store path (no cross-device rename failures).\n\n### Interrupted/partial uploads\n- Temp files MUST use a naming convention (e.g. `.tmp.\u003cpid\u003e.\u003ctimestamp\u003e`) for identification.\n- On startup, worker MUST sweep store for orphaned temp files older than configurable threshold (default: 1 hour) and delete them.\n\n### Corrupted bundle detection\n- After writing temp file, verify content_sha256 BEFORE rename. Mismatch -\u003e delete temp, return INVALID_REQUEST.\n- After decompression, verify canonical bundle digest matches source_sha256. Mismatch -\u003e delete, return INVALID_REQUEST.\n\n### GC race conditions\n- GC MUST acquire advisory lock per bundle dir before deletion.\n- GC MUST re-check no RUNNING jobs reference bundle after lock (double-check pattern).\n- Upload writes to temp (outside bundle dir) then renames -- no deadlock with GC.\n\n### Store directory initialization\n- Create store root with permissions 0750 on first use if missing.\n- Fail immediately on startup if store root is on read-only filesystem.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:18.865684631Z","created_by":"root","updated_at":"2026-02-11T19:41:38.095443022+01:00","closed_at":"2026-02-11T19:41:38.095443022+01:00","close_reason":"Source store implementation complete: content-addressed storage with two-level fan-out, atomic writes, GC protection, all tests passing","dependencies":[{"issue_id":"rch-mac-axz.9","depends_on_id":"rch-mac-axz","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-axz.9","depends_on_id":"rch-mac-sai.5","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-b7s","title":"M7: Hardening and Conformance (Post-MVP)","description":"Milestone 7 (post-MVP): Attestation signing, ephemeral simulator provisioning, artifact profiles, resumable uploads, conformance test suite, JSON Schema files, and fixture project for golden-file assertions.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:48.471123347Z","created_by":"root","updated_at":"2026-02-10T22:21:48.471123347Z","dependencies":[{"issue_id":"rch-mac-b7s","depends_on_id":"rch-mac-y6s","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-b7s.1","title":"Attestation signing (Ed25519) + key pinning","description":"Worker signs attestation.json with Ed25519 key. Host verifies signature, records attestation_verification.json. If verification fails, mark run as failed (failure_kind=ATTESTATION, exit_code=93). Host worker inventory may pin attestation_pubkey_fingerprint — if pinned, verify fingerprint match before accepting signed attestations.","notes":"## attestation_verification.json\nThis bead MUST also emit attestation_verification.json on the host side after verifying a signed attestation. This artifact records: schema_version, schema_id (rch-xcode/attestation_verification@1), created_at, run_id, job_id, verification_result (pass/fail), pubkey_fingerprint, pinned_fingerprint (if configured), signature_algorithm.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:49.278334848Z","created_by":"root","updated_at":"2026-02-11T07:57:53.643256784Z","dependencies":[{"issue_id":"rch-mac-b7s.1","depends_on_id":"rch-mac-b7s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-b7s.10","title":"M7 tests: hardening and conformance","description":"Tests for M7-specific hardening features (beyond what earlier milestone tests cover).\n\n**Test cases:**\n\n1. **Attestation signing (Ed25519):**\n   - Worker signs attestation.json with Ed25519 key\n   - Host verifies signature → pass\n   - Tamper with attestation.json after signing → host detects invalid signature, `failure_kind=ATTESTATION`\n   - Pass: valid signature accepted, tampered signature rejected\n\n2. **Attestation key pinning:**\n   - Host inventory pins `attestation_pubkey_fingerprint=\u003cexpected\u003e`\n   - Worker provides matching key → verification succeeds\n   - Worker provides different key → host rejects before accepting attestation\n   - Pass: fingerprint match accepted, mismatch rejected with diagnostic\n\n3. **Ephemeral simulator provisioning:**\n   - Job with `destination.provisioning=ephemeral` and simulator destination\n   - Expected: worker creates clean simulator named `rch-ephemeral-\u003cjob_id\u003e`\n   - Verify: simulator UDID recorded in destination.json (but NOT in job_key_inputs — UDID must not affect cache key)\n   - Pass: fresh simulator created, UDID in artifacts, UDID absent from job_key_inputs\n\n4. **Ephemeral simulator cleanup — happy path:**\n   - After artifact collection, worker deletes the ephemeral simulator\n   - Pass: simulator no longer exists (verify via simctl list)\n\n5. **Ephemeral cleanup failure:**\n   - Simulate cleanup failure (e.g. simulator in use)\n   - Expected: worker logs WARNING in build.log, `summary.json` has `ephemeral_cleanup_failed: true`\n   - Pass: warning logged, flag set, job still succeeds (cleanup failure is non-fatal)\n\n6. **Orphaned ephemeral cleanup on startup:**\n   - Create simulator named `rch-ephemeral-\u003cold_job_id\u003e` (simulating previous crash)\n   - Worker starts up → SHOULD delete orphaned simulators matching naming convention\n   - Pass: orphaned simulator removed during startup sweep\n\n7. **Artifact profiles — minimal vs rich:**\n   - Request `artifact_profile=minimal`: only normative artifacts (summary.json, manifest.json, attestation.json, build.log, etc.)\n   - Request `artifact_profile=rich`: additionally events.jsonl, build_summary.json (build), test_summary.json + junit.xml (test)\n   - Verify: `summary.json` records actual `artifact_profile` produced\n   - Pass: minimal has only required files, rich has additional files\n\n8. **Resumable uploads (feature upload_resumable):**\n   - Start upload, interrupt at 50%\n   - Resume with `upload_id` and `offset` → upload completes\n   - Verify: final bundle integrity (source_sha256 matches)\n   - Pass: resumed upload produces correct bundle\n\n9. **JSON Schema validation of ALL artifacts:**\n   - Generate a complete run (build + test) with all normative + recommended artifacts\n   - Validate every JSON file against its schema from `schemas/rch-xcode/`\n   - Pass: zero validation errors across all artifacts\n\n10. **Golden-file assertions with fixture project:**\n    - Run the minimal fixture Xcode project (from rch-mac-b7s.7) through full pipeline\n    - Compare key artifact fields against golden files (known-good values)\n    - Fields to golden-check: job_key (deterministic), source_sha256 (deterministic), exit codes, status values, schema versions\n    - Pass: all golden-checked fields match. Update goldens explicitly when contract changes.\n\n11. **Executor environment audit (executor_env.json):**\n    - Verify emitted file contains: `passed_keys[]`, `dropped_keys[]`, `overrides[]` (at least DEVELOPER_DIR)\n    - Verify: no env var values recorded by default (keys only)\n    - Verify: DEVELOPER_DIR appears in `overrides[]`\n    - Pass: all fields present, no values leaked\n\n**Pass/fail:** Each test has explicit expected artifacts/fields. Tests requiring a live worker (ephemeral sim, real Xcode) are tagged `[live-worker]` and skipped in mock-only CI. Golden-file tests use fixtures from rch-mac-b7s.7.\n\n**Logging:** Tests verify appropriate log levels for each hardening feature. Attestation signing logs at INFO (key used, verification result). Ephemeral sim logs at INFO (create/delete) and WARN (cleanup failure).\n","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:56.074558645Z","created_by":"root","updated_at":"2026-02-11T07:22:09.480280765Z","dependencies":[{"issue_id":"rch-mac-b7s.10","depends_on_id":"rch-mac-b7s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-b7s.10","depends_on_id":"rch-mac-b7s.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-b7s.10","depends_on_id":"rch-mac-b7s.2","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-b7s.10","depends_on_id":"rch-mac-b7s.5","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-b7s.10","depends_on_id":"rch-mac-b7s.6","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-b7s.10","depends_on_id":"rch-mac-b7s.7","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-b7s.2","title":"Ephemeral simulator provisioning","description":"When destination.provisioning=ephemeral and destination is Simulator: worker provisions clean simulator per job (naming convention: rch-ephemeral-\u003cjob_id\u003e). Records created UDID in artifacts (UDID must NOT affect job_key). Cleanup: worker must delete provisioned simulator after artifact collection or cancellation. If cleanup fails, log warning in build.log and record ephemeral_cleanup_failed: true in summary.json. Startup sweep: workers should delete orphaned ephemeral simulators from previous crashed runs (identifiable by naming convention).","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:50.035932625Z","created_by":"root","updated_at":"2026-02-10T22:21:50.035932625Z","dependencies":[{"issue_id":"rch-mac-b7s.2","depends_on_id":"rch-mac-b7s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-b7s.3","title":"Artifact profiles (minimal/rich)","description":"Jobs may request artifact_profile: minimal (default, only minimum artifacts) or rich (adds events.jsonl, build_summary.json for build jobs, test_summary.json + junit.xml for test jobs). summary.json records artifact_profile actually produced. Profile affects result cache reuse (cached profile must be \u003e= requested).","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:50.83691029Z","created_by":"root","updated_at":"2026-02-10T22:21:50.83691029Z","dependencies":[{"issue_id":"rch-mac-b7s.3","depends_on_id":"rch-mac-b7s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-b7s.4","title":"Resumable uploads","description":"When worker advertises feature upload_resumable: upload_source payload includes optional resume object with upload_id and offset. Worker responds with next_offset for resumable uploads. Enables recovery from interrupted large bundle uploads.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:51.564799918Z","created_by":"root","updated_at":"2026-02-10T22:21:51.564799918Z","dependencies":[{"issue_id":"rch-mac-b7s.4","depends_on_id":"rch-mac-b7s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-b7s.5","title":"Conformance test suite","description":"Conformance test suite (M7). This is an AGGREGATION layer — it does NOT re-implement tests from earlier milestones. Instead it provides a single `rch xcode conformance` runner that executes all conformance categories and produces a structured pass/fail report.\n\n**What this bead adds beyond earlier test beads:**\n\n1. **Conformance runner harness:**\n   - Single entry point that runs all conformance categories\n   - Structured JSON output: `{category, test_name, pass, duration_ms, error?}` per test\n   - Exit code 0 if all pass, 1 if any fail\n   - CI integration: can be wired into GitHub Actions / pre-merge gates\n\n2. **Protocol replay tests (NEW — not covered by earlier beads):**\n   - Record request/response transcripts during mock worker tests\n   - Replay recorded transcripts against host logic → must produce identical decisions\n   - Replay against mock worker → must produce identical responses\n   - This validates determinism of both host and worker protocol handling\n   - Pass: replayed outputs byte-identical to original recordings\n\n3. **Cross-milestone integration validation (NEW):**\n   - Full pipeline from M1 classifier through M4 artifacts with M1.5 mock worker\n   - Verify: all artifacts from every milestone are present and cross-reference correctly\n   - Example: job_key in summary.json matches job_key in attestation.json matches job_key in manifest entries\n   - Pass: complete artifact graph is internally consistent\n\n4. **Conformance categories (references to existing test beads):**\n   - Classifier correctness → delegates to rch-mac-n4q.6 corpus\n   - JobSpec determinism → delegates to rch-mac-axz.24 tests\n   - Source bundle reproducibility → delegates to rch-mac-axz.25 tests\n   - Artifact schema compliance → validates all JSON against JSON Schemas from rch-mac-b7s.6\n   - Protocol round-trip → delegates to rch-mac-666.* tests\n   - State machine transitions → delegates to rch-mac-axz.24 tests\n\n5. **Mock worker conformance:**\n   - Verify the shipped mock worker handles all RPC ops with schema-valid responses\n   - Verify mock worker rejects malformed requests per protocol spec\n   - Pass: mock worker passes all protocol tests from 666.* beads\n\n**Pass/fail:** Overall: all categories pass = conformance suite passes. Individual: each test has explicit pass/fail from its source bead. Runner must report first failure details for debugging.\n\n**Logging:** Runner logs at INFO: category start/end, pass/fail count. At DEBUG: individual test results. Output includes total duration and per-category summary.\n","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:52.262432659Z","created_by":"root","updated_at":"2026-02-11T07:21:40.814510384Z","dependencies":[{"issue_id":"rch-mac-b7s.5","depends_on_id":"rch-mac-b7s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-b7s.6","title":"JSON Schema files (schemas/rch-xcode/)","description":"Ship machine-readable JSON Schemas for all normative artifacts under schemas/rch-xcode/. Naming: \u003cartifact_name\u003e.schema.json. Each schema includes  matching schema_id. Use JSON Schema 2020-12 consistently. Schemas: job.schema.json, summary.schema.json, run_plan.schema.json, run_summary.schema.json, run_state.schema.json, job_state.schema.json, manifest.schema.json, attestation.schema.json, capabilities.schema.json, toolchain.schema.json, destination.schema.json, effective_config.schema.json, invocation.schema.json, source_manifest.schema.json, worker_selection.schema.json, run_index.schema.json, job_index.schema.json, job_key_inputs.schema.json, metrics.schema.json.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:52.957971387Z","created_by":"root","updated_at":"2026-02-10T22:21:52.957971387Z","dependencies":[{"issue_id":"rch-mac-b7s.6","depends_on_id":"rch-mac-b7s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-b7s.7","title":"Fixture project for golden-file assertions","description":"Create minimal Xcode fixture project with build + test targets and stable outputs for golden assertions. Classifier fixtures: corpus of accepted/rejected xcodebuild invocations including tricky edge cases. Source bundle reproducibility fixture: identical repo inputs on Linux/macOS must produce identical source_sha256.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:53.70413992Z","created_by":"root","updated_at":"2026-02-10T22:21:53.70413992Z","dependencies":[{"issue_id":"rch-mac-b7s.7","depends_on_id":"rch-mac-b7s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-b7s.8","title":"rch xcode doctor command","description":"Implement rch xcode doctor — validates worker reachability, protocol compatibility, Xcode pinning, and destination availability. Diagnostic command that checks everything needed for a successful run without actually running one.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:54.521309762Z","created_by":"root","updated_at":"2026-02-10T22:21:54.521309762Z","dependencies":[{"issue_id":"rch-mac-b7s.8","depends_on_id":"rch-mac-b7s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-b7s.9","title":"rch xcode fetch command","description":"Implement rch xcode fetch \u003cjob_id\u003e — materialize remote artifacts locally if stored remotely. Uses fetch RPC with binary framing (JSON header + tar bytes). Verify content_sha256, then verify manifest integrity per host manifest verification rules.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-10T22:21:55.322028637Z","created_by":"root","updated_at":"2026-02-10T22:21:55.322028637Z","dependencies":[{"issue_id":"rch-mac-b7s.9","depends_on_id":"rch-mac-b7s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-faf","title":"M3: XcodeBuildMCP Backend","description":"Milestone 3: Implement XcodeBuildMCP as an alternative backend. Selected via backend=mcp in .rch/xcode.toml. NOT a fallback — explicit choice per repo config. Same artifact contract as xcodebuild backend (summary.json must include backend=mcp, same exit_code mapping). Richer diagnostics, structured build/test events, multi-step orchestration support. Must still write all normative artifacts (summary.json, manifest.json, attestation.json, job_state.json, logs). Must still control output paths (user args must not override artifact locations).","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-10T22:21:30.423502757Z","created_by":"root","updated_at":"2026-02-10T22:21:30.423502757Z","dependencies":[{"issue_id":"rch-mac-faf","depends_on_id":"rch-mac-axz","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-faf.1","title":"XcodeBuildMCP executor implementation","description":"Implement XcodeBuildMCP backend executor on worker. Same contract as xcodebuild backend but using MCP protocol for richer interaction. Must: execute action from job.json, write all normative artifacts, control output paths, emit events.jsonl for structured progress, produce richer build_summary.json and test_summary.json. Exit code mapping: xcodebuild failures → exit 50, MCP-specific failures → exit 60. Backend identity in summary.json: backend=mcp.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-10T22:21:31.143420675Z","created_by":"root","updated_at":"2026-02-10T22:21:31.143420675Z","dependencies":[{"issue_id":"rch-mac-faf.1","depends_on_id":"rch-mac-faf","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-faf.2","title":"M3 tests: MCP backend conformance","description":"Tests for M3 MCP backend conformance. Verify XcodeBuildMCP produces artifacts that satisfy the same normative contracts as the xcodebuild backend.\n\n**Test cases:**\n\n1. **Artifact structure parity:**\n   - Run same build+test job via MCP backend\n   - Verify all normative artifacts present: summary.json, manifest.json, attestation.json, job_state.json, toolchain.json, destination.json, effective_config.json, invocation.json, job_key_inputs.json, job.json, build.log, job_index.json\n   - For test jobs: result.xcresult/ present\n   - Pass: every file that xcodebuild backend produces is also present with MCP\n\n2. **summary.json schema compliance:**\n   - Verify `backend` field = `\"mcp\"` (not `\"xcodebuild\"`)\n   - Verify all required fields present per summary.json schema (schema_version, schema_id, run_id, job_id, job_key, status, exit_code, human_summary, duration_ms)\n   - Verify exit code mapping: successful MCP job → exit_code=0, MCP failure → exit_code=60 (MCP_FAILED)\n   - Pass: schema validates, correct backend identity and exit codes\n\n3. **Rich artifact profile:**\n   - Request `artifact_profile=rich`\n   - Verify MCP emits: events.jsonl, build_summary.json (build jobs), test_summary.json + junit.xml (test jobs)\n   - Pass: all rich artifacts present and non-empty\n\n4. **events.jsonl format:**\n   - Each line is valid JSON with `ts`, `stage`, `kind`, optional `data`\n   - `ts` is RFC 3339 UTC\n   - Pass: all lines parse, required fields present\n\n5. **Failure mapping:**\n   - MCP backend returns error → summary.json has `failure_kind=MCP`, `exit_code=60`\n   - MCP backend times out → `failure_subkind=TIMEOUT_OVERALL` or `TIMEOUT_IDLE`\n   - Pass: correct failure taxonomy mapping\n\n6. **Cancellation via MCP:**\n   - Cancel running MCP job → backend process tree terminated, summary.json has `status=cancelled`, `exit_code=80`\n   - Pass: clean cancellation, same contract as xcodebuild backend\n\n**Pass/fail:** Tests compare MCP output against xcodebuild backend's normative contract (not byte-for-byte, but schema-for-schema). Uses fixture Xcode project. Requires MCP backend available on test worker.\n\n**Logging:** MCP executor MUST log at INFO: MCP connection established, job started, job completed. At DEBUG: MCP protocol messages. Tests verify MCP-specific log entries present.\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-10T22:21:31.966997634Z","created_by":"root","updated_at":"2026-02-11T07:20:21.283418264Z","dependencies":[{"issue_id":"rch-mac-faf.2","depends_on_id":"rch-mac-faf","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-faf.2","depends_on_id":"rch-mac-faf.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-n4q","title":"M1: Classifier (Safety Gate)","description":"Milestone 1: Implement the deny-by-default classifier that gates xcodebuild invocations. The classifier is the critical safety component — it determines whether an xcodebuild command line is safe and supported for remote execution. It must match only supported forms, reject unknown flags/actions by default, enforce repo config constraints, and emit machine-readable explanations. False negatives (rejecting safe commands) are preferred over false positives (accepting unsafe ones). The classifier operates entirely on the host side, before any remote communication.","status":"closed","priority":1,"issue_type":"task","assignee":"EmeraldHeron","created_at":"2026-02-10T22:21:02.177278466Z","created_by":"root","updated_at":"2026-02-11T11:38:27.145576393Z","closed_at":"2026-02-11T11:38:27.145408661Z"}
{"id":"rch-mac-n4q.1","title":"Classifier core: argv parsing and allowlist matching","description":"Implement the core classifier that pattern-matches xcodebuild argv against an allowlist. Supported actions (initial): build, test. Explicitly denied: archive, -exportArchive, -exportNotarizedApp, notarization/signing flows. Explicitly denied flags: -resultBundlePath (worker controls output paths), -derivedDataPath (worker controls per cache mode). Allowed flags (minimal safe subset): -workspace OR -project (must match repo config), -scheme (must match repo config), -destination (must match resolved/pinned destination), -configuration (optional, must be pinned or whitelisted if allowed). ALL other flags must be rejected unless explicitly added to allowlist. The classifier must: 1) Parse the argv into action + flags, 2) Check action against allowed set, 3) Check each flag against allowlist, 4) Validate flag values against repo config constraints, 5) Produce accept/reject decision with structured reasons. Implementation should be a pure function: (argv, config) -\u003e ClassifierResult.\n\n## ClassifierResult type\n```\nClassifierResult {\n  accepted: bool\n  action: \"build\" | \"test\" | null        // null when rejected\n  sanitized_argv: string[] | null         // canonical ordering, null when rejected\n  rejected_flags: string[]                // flags that caused rejection (may be empty)\n  rejection_reasons: string[]             // machine-readable reason strings (e.g. \"DENIED_ACTION:archive\", \"UNKNOWN_FLAG:-foo\", \"SCHEME_MISMATCH:BadScheme\")\n  matched_constraints: {                  // what config constraints were applied\n    workspace: string | null\n    project: string | null\n    scheme: string\n    destination: string | null\n    configuration: string | null\n  }\n}\n```\n\n## Sanitized argv canonical ordering\nFlags in sanitized_argv MUST be emitted in a deterministic order: action first, then flags sorted lexicographically by flag name, with each flag's value immediately following. Example: `[\"build\", \"-configuration\", \"Debug\", \"-destination\", \"platform=iOS Simulator,...\", \"-scheme\", \"MyApp\", \"-workspace\", \"MyApp.xcworkspace\"]`\n\n## xcodebuild argv parsing\nThe parser must handle xcodebuild's flag conventions:\n- Single-dash flags with space-separated values: `-workspace Foo.xcworkspace`\n- Actions are bare words: `build`, `test`, `archive`\n- Some flags are boolean (no value): these must still be recognized and classified\n- Unknown flags: any flag not in the explicit allowlist MUST be rejected\n","acceptance_criteria":"- Pure function: (argv: string[], config: RepoConfig) → ClassifierResult\n- ClassifierResult type: { accepted: bool, action?: \"build\"|\"test\", sanitized_argv?: string[], rejected_flags?: string[], rejection_reasons?: string[] }\n- Accepts: `xcodebuild build -workspace Foo.xcworkspace -scheme Bar` when config allows workspace=Foo.xcworkspace, scheme=Bar\n- Rejects: `xcodebuild archive ...` (denied action)\n- Rejects: `xcodebuild build -resultBundlePath /tmp/out ...` (denied flag)\n- Rejects: `xcodebuild build -scheme Unknown ...` (scheme not in config allowlist)\n- Rejects unknown/unrecognized flags by default\n- sanitized_argv has deterministic ordering (sorted flags, normalized quoting)\n- rejection_reasons are machine-readable strings identifying each violation","status":"closed","priority":1,"issue_type":"task","assignee":"EmeraldHeron","created_at":"2026-02-10T22:21:02.932702765Z","created_by":"root","updated_at":"2026-02-11T14:04:27.837353092Z","closed_at":"2026-02-11T14:04:27.837043376Z","close_reason":"Complete: Classifier core fully implemented with argv parsing, allowlist matching, rejection reasons, sanitized argv ordering, policy hashing. 235 tests passing.","dependencies":[{"issue_id":"rch-mac-n4q.1","depends_on_id":"rch-mac-n4q","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}],"comments":[{"id":3,"issue_id":"rch-mac-n4q.1","author":"Paul Robinshaw","text":"## Implementation Progress (EmeraldHeron)\n\n### Core Implementation Complete\n\nFiles created:\n- Cargo.toml - Rust project scaffold\n- src/lib.rs - Library root\n- src/classifier/mod.rs - Main classifier with Classifier struct\n- src/classifier/parser.rs - xcodebuild argv parser\n- src/classifier/result.rs - ClassifierResult and RejectionReason types\n\n### Features Implemented\n1. Parse xcodebuild argv (actions, flags, boolean flags, build settings)\n2. Allowlist/denylist matching per PLAN.md spec\n3. ClassifierResult with machine-readable rejection reasons\n4. Sanitized argv with canonical ordering (action first, flags sorted)\n5. Config constraint validation (workspace, project, scheme, configuration)\n\n### Test Coverage\n14 tests passing:\n- Parser: 5 tests (simple build, xcodebuild prefix, boolean flags, destination, build settings)\n- Classifier: 7 tests (accept build/test, reject archive/unknown/mismatch, ordering)\n- Result: 2 tests (serialization, machine strings)\n\n### Remaining Work\n- More comprehensive test corpus (per rch-mac-n4q.6)\n- invocation.json emission (rch-mac-n4q.3)\n- explain command integration (rch-mac-n4q.4)","created_at":"2026-02-11T10:49:54Z"}]}
{"id":"rch-mac-n4q.2","title":"Repo config for classifier constraints (.rch/xcode.toml)","description":"Define and implement the .rch/xcode.toml repo config format for classifier constraints. Must support: workspace or project path (pinned), allowed schemes (array), allowed destinations (array of constraint strings), allowed configurations (array, optional), verify actions (ordered array of {action: build|test, args...} for rch xcode verify). The config is included in the source bundle so the worker always has consistent constraints. Config validation: reject if both workspace and project specified, reject if no schemes defined, validate destination constraint syntax. This config is layer 3 in the merge precedence (built-in defaults → host config → repo config → CLI flags).","acceptance_criteria":"- .rch/xcode.toml parsed with: workspace/project (pinned), schemes (array), destinations (array), configurations (optional array), verify actions (ordered array of {action, args})\n- Rejects if both workspace and project specified\n- Rejects if no schemes defined\n- Destination constraint syntax validated\n- Config included in source bundle\n- Integrates as layer 3 in merge precedence","status":"closed","priority":1,"issue_type":"task","assignee":"EmeraldHeron","created_at":"2026-02-10T22:21:03.683074843Z","created_by":"root","updated_at":"2026-02-11T11:31:53.753449286Z","closed_at":"2026-02-11T11:31:53.753239196Z","dependencies":[{"issue_id":"rch-mac-n4q.2","depends_on_id":"rch-mac-n4q","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-n4q.3","title":"Emit invocation.json with sanitized argv","description":"When the classifier accepts an invocation, emit invocation.json containing: original_argv (as received), sanitized_argv (canonical ordering, normalized quoting — must NOT contain output path overrides, script hooks, or unconstrained destinations), accepted_action (build or test), rejected_flags (if any, for dry-run/explain), classifier_policy_sha256 (sha256 hex of the effective classifier policy snapshot). Sanitized_argv is used in job_key_inputs for cache keying, so canonical ordering is critical for determinism.","acceptance_criteria":"- invocation.json emitted with: original_argv, sanitized_argv, accepted_action, rejected_flags, classifier_policy_sha256\n- sanitized_argv has deterministic canonical ordering\n- sanitized_argv excludes: output path overrides, script hooks, unconstrained destinations\n- classifier_policy_sha256 is sha256 hex of effective classifier policy snapshot bytes","status":"closed","priority":1,"issue_type":"task","assignee":"EmeraldHeron","created_at":"2026-02-10T22:21:04.472153134Z","created_by":"root","updated_at":"2026-02-11T11:27:22.644543516Z","closed_at":"2026-02-11T11:27:22.644078302Z","dependencies":[{"issue_id":"rch-mac-n4q.3","depends_on_id":"rch-mac-n4q","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-n4q.3","depends_on_id":"rch-mac-n4q.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-n4q.4","title":"Implement rch xcode explain command","description":"Implement rch xcode explain -- \u003ccmd...\u003e CLI command. Runs the classifier on the given command and outputs a human/agent-readable explanation of the decision: whether accepted or rejected, which constraints matched/failed, what the effective allowlist is, what the sanitized form would be, and the classifier policy snapshot. This is a diagnostic command — no remote execution occurs. Output should be structured JSON (for agents) with an optional --human flag for readable format.","status":"closed","priority":2,"issue_type":"task","assignee":"EmeraldHeron","created_at":"2026-02-10T22:21:05.225497328Z","created_by":"root","updated_at":"2026-02-11T11:34:20.051751491Z","closed_at":"2026-02-11T11:34:20.051501727Z","dependencies":[{"issue_id":"rch-mac-n4q.4","depends_on_id":"rch-mac-n4q","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-n4q.4","depends_on_id":"rch-mac-n4q.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-n4q.4","depends_on_id":"rch-mac-n4q.2","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-n4q.5","title":"Classifier policy snapshot (classifier_policy.json)","description":"Emit classifier_policy.json per job: schema_version (1), schema_id (rch-xcode/classifier_policy@1), created_at, run_id, job_id, job_key, capturing the effective allowlist/denylist and any pinned constraints enforced by the classifier (workspace/project, scheme, destination rules, allowed flags). This enables auditability and replayable explain. The sha256 hex digest of the canonical JSON bytes of this snapshot is recorded in invocation.json as classifier_policy_sha256. Recommended but included in MVP for completeness.","status":"closed","priority":2,"issue_type":"task","assignee":"EmeraldHeron","created_at":"2026-02-10T22:21:05.985743439Z","created_by":"root","updated_at":"2026-02-11T11:38:08.02954143Z","closed_at":"2026-02-11T11:38:08.029317764Z","dependencies":[{"issue_id":"rch-mac-n4q.5","depends_on_id":"rch-mac-n4q","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-n4q.5","depends_on_id":"rch-mac-n4q.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-n4q.6","title":"M1 tests: classifier correctness corpus","description":"Comprehensive classifier test suite using a fixture corpus approach. Each test case is a tuple of (input_argv, repo_config, expected_result).\n\n**Test categories:**\n\n1. **Accepted invocations (pass = classifier returns accepted=true with correct sanitized_argv):**\n   - `xcodebuild build -workspace Foo.xcworkspace -scheme Bar` with config allowing Foo.xcworkspace + Bar scheme\n   - `xcodebuild test -workspace Foo.xcworkspace -scheme Bar -destination \"platform=iOS Simulator,name=iPhone 16\"` with matching pinned destination\n   - Minimal flags (just workspace + scheme, action inferred)\n   - `-configuration Debug` when Debug is in config allowlist\n\n2. **Rejected invocations (pass = classifier returns accepted=false with rejection_reason string):**\n   - `archive`, `-exportArchive`, `-exportNotarizedApp` actions → rejection_reason mentions denied action\n   - `-resultBundlePath /tmp/foo` → rejection_reason mentions output path override\n   - `-derivedDataPath /tmp/dd` → rejection_reason mentions output path override\n   - Unknown flags (`-enableAddressSanitizer YES` if not in allowlist) → rejection_reason names the flag\n   - `-scheme NotAllowed` when not in allowed list → rejection_reason mentions scheme mismatch\n   - `-workspace Wrong.xcworkspace` mismatch → rejection_reason mentions workspace\n   - Missing required `-scheme` → rejection_reason mentions missing scheme\n\n3. **Edge cases (each has explicit expected outcome):**\n   - Empty argv → rejected, rejection_reason indicates empty invocation\n   - `xcodebuild` with no action keyword → rejected (no implicit action)\n   - Duplicate flags (`-scheme A -scheme B`) → rejected (ambiguous)\n   - Flag values with spaces: `-destination \"platform=iOS Simulator,name=iPhone 16 Pro\"` → accepted if destination matches\n   - Case sensitivity: `-Scheme` vs `-scheme` → rejected (unknown flag)\n   - Flags after `--`: ignored or rejected per policy\n\n4. **Constraint validation (config-dependent):**\n   - Scheme not in `allowed_schemes` list → rejected\n   - Workspace path mismatch → rejected\n   - Destination not matching any pinned destination constraint → rejected\n\n5. **Sanitized argv determinism:**\n   - Input: same flags in different orderings (e.g. `-scheme A -workspace B` vs `-workspace B -scheme A`)\n   - Pass criterion: all produce byte-identical `sanitized_argv` arrays\n   - Verify sanitized_argv excludes output path overrides and script hooks\n\n6. **invocation.json output validation:**\n   - For each accepted case, verify emitted invocation.json contains: `original_argv`, `sanitized_argv`, `accepted_action` (build|test), `classifier_policy_sha256`\n   - For rejected cases in dry-run/explain mode, verify `rejected_flags` array is populated\n\n7. **Policy snapshot stability:**\n   - Same config → same `classifier_policy_sha256` across runs\n   - Different config → different `classifier_policy_sha256`\n\n**Pass/fail:** Each fixture has an expected outcome (accepted/rejected + specific fields). Test fails if actual != expected. All tests run without a live worker. Corpus should have ≥30 test cases covering all categories.\n\n**Logging:** Classifier MUST log at DEBUG level: each flag parsed, match/reject decision with reason. Tests should verify log output contains the flag name and decision for at least one accepted and one rejected case.\n","status":"closed","priority":1,"issue_type":"task","assignee":"EmeraldHeron","created_at":"2026-02-10T22:21:06.786244662Z","created_by":"root","updated_at":"2026-02-11T11:36:12.775356302Z","closed_at":"2026-02-11T11:36:12.77514606Z","dependencies":[{"issue_id":"rch-mac-n4q.6","depends_on_id":"rch-mac-n4q","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-n4q.6","depends_on_id":"rch-mac-n4q.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-n4q.6","depends_on_id":"rch-mac-n4q.3","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-sai","title":"M0: Worker Connectivity","description":"Milestone 0: Establish SSH connectivity to macOS worker (Mac mini). Worker must be reachable via SSH, tagged macos,xcode in host worker inventory (~/.config/rch/workers.toml). This is the foundation — nothing else works without a reachable, probed worker. Includes SSH hardening setup (dedicated rch user, forced-command entrypoint), initial capabilities.json capture via probe, and worker inventory configuration. Success criteria: rch workers probe \u003cworker\u003e returns valid capabilities.json with Xcode versions, macOS version, architecture, available simulators/devices, and capacity info.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:20:56.545033138Z","created_by":"root","updated_at":"2026-02-11T15:30:09.654064005Z","closed_at":"2026-02-11T15:30:09.653974529Z","close_reason":"All sub-tasks complete (sai.1-6 all closed)"}
{"id":"rch-mac-sai.1","title":"Worker SSH setup and hardening","description":"Set up dedicated rch user on Mac mini worker with SSH key-based auth. Configure forced-command entrypoint that only runs the worker RPC handler (no interactive shell). Disable agent forwarding, set no-pty, restrict source addresses where possible. Pin worker host keys in host config to prevent TOFU surprises. The SSH config should use a dedicated key pair for rch operations. Document the setup steps for reproducibility. Security rationale: the worker executes arbitrary Xcode build phases from repo code, so it should be treated as a CI machine — minimize attack surface by restricting SSH capabilities to the minimum needed for JSON RPC over stdin/stdout.","acceptance_criteria":"- Dedicated rch user created on Mac mini with SSH key auth\n- Forced-command entrypoint: only runs worker RPC handler\n- Agent forwarding disabled, no-pty set\n- Worker host key pinned in host SSH config\n- Setup documented for reproducibility","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:20:57.61316037Z","created_by":"root","updated_at":"2026-02-11T13:10:44.148827863Z","closed_at":"2026-02-11T13:10:44.148614796Z","dependencies":[{"issue_id":"rch-mac-sai.1","depends_on_id":"rch-mac-sai","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-sai.2","title":"Worker inventory configuration (workers.toml)","description":"Implement worker inventory file at ~/.config/rch/workers.toml. Each worker entry must include: name (unique identifier), host (SSH hostname/IP), port (default 22), user (default rch), tags (array of strings, must include macos and xcode for Xcode lane workers), identity_file (path to SSH private key), priority (integer for deterministic selection ordering), and optional fields like attestation_pubkey_fingerprint. The inventory parser must validate all fields, reject duplicates, and provide clear error messages. Tags are used for filtering in worker selection (M2). Priority is used for deterministic ordering when multiple workers match. Format: TOML with [[workers]] array of tables.","acceptance_criteria":"- workers.toml at ~/.config/rch/workers.toml parsed correctly\n- Each entry: name (unique), host, port (default 22), user (default rch), tags (string array), identity_file, priority (int), optional attestation_pubkey_fingerprint\n- Duplicate names rejected with clear error\n- Missing required fields rejected with clear error\n- Tags used for filtering in worker selection","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:20:58.407818391Z","created_by":"root","updated_at":"2026-02-11T13:07:20.204854987Z","closed_at":"2026-02-11T13:07:20.204871937Z","dependencies":[{"issue_id":"rch-mac-sai.2","depends_on_id":"rch-mac-sai","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-sai.3","title":"Implement rch workers probe command","description":"Implement rch workers probe \u003cworker\u003e CLI command. This command SSHs to the named worker, executes the worker RPC entrypoint with a probe request (protocol_version: 0, op: probe), and captures the response as capabilities.json. The probe response must include: rch_xcode_lane_version, protocol_min/protocol_max (inclusive range), features array (e.g. tail, fetch, events, has_source, upload_source, attestation_signing), and a full capabilities payload. Capabilities must include: installed Xcode versions (array of {version, build, path, developer_dir}), active Xcode (DEVELOPER_DIR), macOS version + build + architecture, available simulators/runtimes from simctl (including runtime identifiers and build strings), installed tooling versions, capacity (max_concurrent_jobs, disk_free), and optional limits (max_upload_bytes, max_artifact_bytes, max_log_bytes). The capabilities.json must include schema_version, schema_id (rch-xcode/capabilities@1), and created_at (RFC 3339 UTC). The probe must use protocol_version: 0 as the sentinel for version negotiation. Store the snapshot locally for caching with a TTL. Output the snapshot to stdout in a human-readable format.","acceptance_criteria":"- rch workers probe \u003cworker\u003e SSHs to worker, sends probe request (protocol_version: 0, op: probe)\n- Parses response capabilities.json with all normative fields\n- Clock skew warning logged if worker timestamp differs \u003e30s from host\n- Snapshot stored locally with TTL for caching\n- Human-readable output to stdout\n- Non-zero exit on probe failure with clear diagnostic","notes":"Clock skew warning (normative): the host SHOULD log a warning if the worker probe response timestamp differs from the host clock by more than 30 seconds, as this may cause confusing artifact timelines.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:20:59.12050835Z","created_by":"root","updated_at":"2026-02-11T13:14:31.182923542Z","closed_at":"2026-02-11T13:14:31.182686411Z","dependencies":[{"issue_id":"rch-mac-sai.3","depends_on_id":"rch-mac-sai","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-sai.3","depends_on_id":"rch-mac-sai.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-sai.3","depends_on_id":"rch-mac-sai.2","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-sai.4","title":"Implement rch workers list command","description":"Implement rch workers list CLI command with optional --tag filter (e.g. --tag macos,xcode). Lists all configured workers from workers.toml, showing name, host, tags, and status (reachable/unreachable based on cached probe). This is primarily a diagnostic/operational command.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-10T22:20:59.807944502Z","created_by":"root","updated_at":"2026-02-11T13:09:30.957486177Z","closed_at":"2026-02-11T13:09:30.957500644Z","dependencies":[{"issue_id":"rch-mac-sai.4","depends_on_id":"rch-mac-sai","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-sai.4","depends_on_id":"rch-mac-sai.2","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-sai.5","title":"Worker RPC entrypoint (stdin/stdout JSON handler)","description":"Implement the worker-side RPC entrypoint: rch-worker xcode rpc. This is the binary that runs on the Mac mini, invoked via SSH forced-command. It reads a single JSON request from stdin, dispatches to the appropriate operation handler, and writes a single JSON response to stdout.\n\n## RPC envelope\nRequest: {protocol_version: int, op: string, request_id: string, payload: object}.\nResponse: {protocol_version: int, request_id: string, ok: bool, payload: object (when ok), error: object (when !ok)}.\nError object: {code: string, message: string, data: object?}.\nError codes registry: INVALID_REQUEST, UNSUPPORTED_PROTOCOL, FEATURE_MISSING, BUSY, LEASE_EXPIRED, SOURCE_MISSING, ARTIFACTS_GONE, PAYLOAD_TOO_LARGE.\n\n## Operations (full dispatch framework)\nThis bead implements the operation dispatch framework and common validation for ALL protocol operations. Individual operation logic is wired in as handlers:\n\n- **probe** (M0): collect system info (sw_vers, xcode-select, xcrun simctl list, disk usage), return capabilities.json. Accepts protocol_version: 0.\n- **reserve** (M2+): accept lease request, return lease_id. Return BUSY at capacity. (Handler wired when lease support added.)\n- **release** (M2+): release lease by lease_id. Idempotent.\n- **submit** (M2): accept job.json, validate job_key matches SHA-256(JCS(job_key_inputs)), validate source_sha256 present in store (→ SOURCE_MISSING if not), check job_id idempotency (same job_id + same job_key → return existing; different job_key → reject), dispatch to executor (axz.10).\n- **status** (M2): return current job state and artifact pointers.\n- **tail** (M2): return log chunk with cursor-based pagination.\n- **cancel** (M2): signal executor to terminate, accept optional `reason` field from host (e.g. `TIMEOUT_OVERALL`, `TIMEOUT_IDLE`) for failure_subkind propagation.\n- **has_source** (M2): check content-addressed store, return {exists: bool}.\n- **upload_source** (M2): accept binary-framed upload per binary framing spec, delegate to store (axz.9).\n- **fetch** (M4): return artifacts as binary-framed response per fetch spec. Return ARTIFACTS_GONE if missing.\n\n## Protocol version enforcement\n- probe accepts protocol_version: 0 exclusively; all other ops reject protocol_version: 0 with UNSUPPORTED_PROTOCOL\n- After probe, host selects a concrete version; worker validates it falls within [protocol_min, protocol_max]\n\n## Binary framing (normative)\nIf payload.stream is present in the request, parse stdin as: single JSON header line terminated by newline, followed by exactly content_length raw bytes. If payload.stream absent, entire stdin is one JSON object. JSON header MUST be compact single-line (no unescaped newlines).\n\n## Capacity enforcement\nTrack active jobs against max_concurrent_jobs (from config). On submit when at capacity, return BUSY with retry_after_seconds in error.data.\n\n## Error message requirements\nSingle-line, human-readable, include specific failing field/value. MUST NOT include secrets, filesystem paths outside job dirs, or stack traces.\n","acceptance_criteria":"- Reads single JSON request from stdin, writes single JSON response to stdout\n- Request envelope validated: protocol_version (int), op (string), request_id (string), payload (object)\n- Unknown ops rejected with INVALID_REQUEST error code\n- Malformed JSON rejected with INVALID_REQUEST\n- Binary framing: if payload.stream present, parse as JSON header line + content_length raw bytes\n- probe op returns capabilities.json with schema_version, schema_id, created_at, Xcode versions, macOS info, runtimes, capacity\n- probe accepts protocol_version: 0; all other ops reject protocol_version: 0 with UNSUPPORTED_PROTOCOL\n- Error responses include code, message (single-line, human-readable, no secrets/stack traces), optional data","notes":"\n## Error handling and recovery\n\n### Stdin EOF / truncated input\n- EOF before complete JSON: return INVALID_REQUEST to stdout (if open), exit nonzero.\n- Binary framing EOF before content_length bytes: INVALID_REQUEST. Delete partial data.\n\n### Malformed binary frames\n- Invalid JSON header: return INVALID_REQUEST.\n- content_length negative or exceeds max_upload_bytes: return PAYLOAD_TOO_LARGE without reading remaining bytes.\n\n### Stdout write failures\n- Broken pipe on response write: log to stderr and exit. No recovery possible.\n\n### Worker process crash during operation\n- Executor crash detected on next status/tail query.\n- Probe system command hangs: per-command timeout (30s), return partial or error.\n\n### Resource limits\n- Maximum request size (10MB for non-binary-framed) to prevent OOM.\n- Binary uploads bounded by max_upload_bytes.\n## Operation milestone mapping\n- probe: M0 (this bead)\n- submit, status, tail, cancel, has_source, upload_source: M2 (handlers wired by axz.*)\n- reserve, release: M6 (0bw.2) — dispatch framework stubs in this bead, handler logic in M6\n- fetch: M4 (y6s.*)\nThe dispatch framework and envelope validation are M0; individual operation handlers are wired progressively.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:00.500547015Z","created_by":"root","updated_at":"2026-02-11T13:56:18.257240812Z","closed_at":"2026-02-11T13:56:18.257096824Z","close_reason":"done","dependencies":[{"issue_id":"rch-mac-sai.5","depends_on_id":"rch-mac-sai","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-sai.6","title":"M0 tests: SSH connectivity and probe","description":"Tests for M0 worker connectivity layer.\n\n**Unit tests:**\n\n1. **Worker inventory parsing (workers.toml):**\n   - Valid config with name, host, tags, priority → parsed correctly\n   - Missing required field (host) → error naming the field\n   - Duplicate worker names → error\n   - Tag filtering: `--tag macos,xcode` returns only workers with both tags\n   - Empty inventory → error (no workers configured)\n   - Pass: each case returns expected result or specific error\n\n2. **capabilities.json schema validation:**\n   - Valid capabilities with all required fields (`schema_version=1`, `schema_id=\"rch-xcode/capabilities@1\"`, `created_at`, Xcode array, macOS version, arch, runtimes, capacity) → accepted\n   - Missing `schema_version` → validation error\n   - Missing `created_at` → validation error\n   - Xcode array entry missing `build` field → validation error\n   - Pass: valid accepted, each invalid case produces specific diagnostic\n\n**Integration tests (mock SSH):**\n\n3. **Probe happy path:**\n   - Mock SSH returns canned probe response JSON\n   - Expected: host parses protocol_min/max, features, capabilities correctly\n   - Pass: parsed fields match canned values\n\n4. **Probe with protocol_version=0:**\n   - Verify host sends `protocol_version: 0` for probe\n   - Verify host correctly parses response (which also has `protocol_version: 0`)\n   - Pass: probe succeeds, negotiation proceeds\n\n5. **Clock skew warning:**\n   - Mock probe response `created_at` is 45 seconds ahead of host clock\n   - Expected: host logs WARNING about \u003e30s clock skew\n   - Pass: warning message present, includes the time difference\n   - Also test: 25 seconds difference → no warning (within tolerance)\n\n6. **Error handling — unreachable worker:**\n   - Mock SSH connection fails (timeout after connect_timeout_seconds)\n   - Expected: error with diagnostic naming the worker and timeout\n   - Pass: specific error, not generic \"connection failed\"\n\n7. **Error handling — malformed response:**\n   - Mock SSH returns invalid JSON\n   - Expected: host fails gracefully with diagnostic mentioning parse error\n   - Pass: error message mentions JSON parse failure\n\n8. **Error handling — SSH timeout:**\n   - Mock SSH hangs beyond connect_timeout_seconds (default 30s)\n   - Expected: host times out with diagnostic\n   - Pass: timeout respected (±1s), error message mentions timeout\n\n**Pass/fail:** Each test case has explicit expected output or error. Mock SSH allows deterministic testing without real network. All tests run in CI.\n\n**Logging:** Host MUST log at INFO: probing worker (name, host). At DEBUG: full probe response. At WARN: clock skew, connection failures. Tests verify probe attempt logged and clock skew warning present/absent as expected.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-10T22:21:01.296933621Z","created_by":"root","updated_at":"2026-02-11T13:53:45.895884971Z","closed_at":"2026-02-11T13:53:45.895913363Z","dependencies":[{"issue_id":"rch-mac-sai.6","depends_on_id":"rch-mac-sai","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-sai.6","depends_on_id":"rch-mac-sai.3","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-sai.6","depends_on_id":"rch-mac-sai.5","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-t7z","title":"Agent-friendly summaries (test_summary, build_summary, junit.xml)","description":"Worker should emit agent-friendly summaries derived from authoritative sources (xcresult when present, logs as fallback): test_summary.json (test counts, failing tests, duration, top failures), build_summary.json (targets, warnings/errors counts, first error location), junit.xml (JUnit XML report for test jobs, enables CI integration). These are recommended artifacts, part of the rich artifact profile (M7) but useful even in MVP for agent consumption.","acceptance_criteria":"- test_summary.json emitted for test jobs: test counts (total, passed, failed, skipped), failing test names, duration, top failures\n- build_summary.json emitted for build jobs: target list, warnings count, errors count, first error location\n- junit.xml emitted for test jobs in standard JUnit XML format\n- All derived from authoritative sources: xcresult when present, build.log as fallback\n- Schema envelope: schema_version, schema_id, created_at, run_id, job_id, job_key","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-10T22:21:57.189821248Z","created_by":"root","updated_at":"2026-02-11T07:57:46.310183152Z","dependencies":[{"issue_id":"rch-mac-t7z","depends_on_id":"rch-mac-axz.10","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-y6s","title":"M4: Artifacts and Attestation","description":"Milestone 4: Complete artifact system with manifest integrity checking, attestation binding, artifact indices, and the two-phase commit protocol. This milestone ensures all artifacts are schema-versioned, internally consistent, and verifiable. Includes artifact completion atomicity (manifest → attestation → job_index as commit marker), host manifest verification, and the full set of normative artifacts.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:32.722062068Z","created_by":"root","updated_at":"2026-02-10T22:21:32.722062068Z","dependencies":[{"issue_id":"rch-mac-y6s","depends_on_id":"rch-mac-axz","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-y6s.1","title":"Artifact manifest (manifest.json) and integrity","description":"Implement manifest.json per job: schema_version, schema_id (rch-xcode/manifest@1), created_at, run_id, job_id, job_key, entries[] (each with path (relative), size, sha256, type (file or directory)), artifact_root_sha256. Entries must be sorted lexicographically by path (UTF-8). For file entries: sha256 and size over file contents. For directory entries: sha256 must be null, size must be 0. artifact_root_sha256 = sha256_hex(JCS(entries)). Inclusion rule: entries must include every file and directory in job artifact dir EXCEPT manifest.json, attestation.json, and job_index.json themselves.","acceptance_criteria":"- manifest.json emitted per job with all normative fields\n- entries[] sorted lexicographically by path (UTF-8)\n- File entries: sha256 and size over file contents\n- Directory entries: sha256=null, size=0\n- artifact_root_sha256 = sha256_hex(JCS(entries))\n- Inclusion rule: all files/dirs except manifest.json, attestation.json, job_index.json","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:33.515969928Z","created_by":"root","updated_at":"2026-02-11T13:05:10.542099344Z","closed_at":"2026-02-11T13:05:10.541424799Z","dependencies":[{"issue_id":"rch-mac-y6s.1","depends_on_id":"rch-mac-y6s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-y6s.2","title":"Host manifest verification","description":"After fetching job artifacts, host MUST: 1) Recompute artifact_root_sha256 from fetched manifest.json entries and verify match. 2) Verify sha256 and size for every entry against fetched files. 3) Verify no extra files exist beyond manifest entries plus the excluded triple (manifest.json, attestation.json, job_index.json). If any check fails: mark job failed with failure_kind=ARTIFACTS, failure_subkind=INTEGRITY_MISMATCH, record mismatched paths/digests in summary.json under integrity_errors[], do NOT use artifacts for caching or attestation verification.","acceptance_criteria":"- Host recomputes artifact_root_sha256 and verifies match\n- Host verifies sha256 and size for every manifest entry\n- Host verifies no extra files beyond manifest entries + excluded triple\n- Failure: failure_kind=ARTIFACTS, failure_subkind=INTEGRITY_MISMATCH\n- Mismatched paths/digests recorded in summary.json integrity_errors[]\n- Failed artifacts not used for caching or attestation","notes":"\n## Error handling and recovery\n\n### Partial download\n- Verification MUST only run after complete download (content_sha256 of tar verified). Interrupted fetch: re-fetch, don't verify partial.\n\n### Verification failure recovery\n- Do NOT delete artifacts on mismatch (preserve for forensics). Mark as INTEGRITY_MISMATCH.\n- If cache hit: invalidate cache entry.\n- Host MAY retry with single re-fetch (possible transient corruption).\n\n### Performance\n- Large artifact sets: streaming hash verification. Pipeline with extraction where possible.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:34.127719309Z","created_by":"root","updated_at":"2026-02-11T07:48:16.437678228Z","dependencies":[{"issue_id":"rch-mac-y6s.2","depends_on_id":"rch-mac-y6s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-y6s.2","depends_on_id":"rch-mac-y6s.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-y6s.3","title":"Attestation (attestation.json)","description":"Implement unsigned attestation per job: attestation.json with job_id, job_key, source_sha256, worker identity (name, stable fingerprint) + capabilities.json digest, backend identity (xcodebuild/MCP version), manifest_sha256 (digest of manifest.json). This binds the artifact set to the job inputs and worker identity. Signing is post-MVP (M7).","acceptance_criteria":"- attestation.json emitted per job with: schema_version (1), schema_id (rch-xcode/attestation@1), created_at, run_id, job_id, job_key, source_sha256, worker identity (name, fingerprint), capabilities_digest (sha256 of capabilities.json bytes), backend identity (name and version), manifest_sha256\n- manifest_sha256 is sha256 of manifest.json bytes\n- No signing for this bead (post-MVP, see b7s.1)","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:34.869924332Z","created_by":"root","updated_at":"2026-02-11T07:57:32.460907746Z","dependencies":[{"issue_id":"rch-mac-y6s.3","depends_on_id":"rch-mac-y6s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-y6s.3","depends_on_id":"rch-mac-y6s.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-y6s.4","title":"Artifact indices (run_index.json, job_index.json)","description":"Implement artifact index files for stable discovery. run_index.json at \u003crun_id\u003e/run_index.json: schema_version, schema_id (rch-xcode/run_index@1), created_at, run_id, pointers to run_plan.json, run_state.json, run_summary.json, source_manifest.json, worker_selection.json, capabilities.json snapshot, ordered step list with {index, action, job_id, job_index_path}. job_index.json at \u003crun_id\u003e/steps/\u003caction\u003e/\u003cjob_id\u003e/job_index.json: pointers to job.json, job_state.json, summary.json, manifest.json, attestation.json, toolchain.json, destination.json, effective_config.json, invocation.json, job_key_inputs.json, build.log, result.xcresult/ (when present), artifact_profile produced. Also pointers to optional artifacts when present: metrics.json, executor_env.json, classifier_policy.json, events.jsonl, test_summary.json, build_summary.json, junit.xml. job_index.json is the COMMIT MARKER — consumers treat its existence as proof the artifact set is complete and consistent.","acceptance_criteria":"- run_index.json at \u003crun_id\u003e/run_index.json with pointers to all run-scoped artifacts\n- job_index.json at \u003crun_id\u003e/steps/\u003caction\u003e/\u003cjob_id\u003e/job_index.json with pointers to all job-scoped artifacts\n- job_index.json includes pointers to optional artifacts when present\n- job_index.json records artifact_profile produced\n- job_index.json existence = commit marker for artifact set completeness","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:35.650190129Z","created_by":"root","updated_at":"2026-02-11T07:28:17.122540108Z","dependencies":[{"issue_id":"rch-mac-y6s.4","depends_on_id":"rch-mac-y6s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-y6s.4","depends_on_id":"rch-mac-y6s.1","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-y6s.4","depends_on_id":"rch-mac-y6s.3","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-y6s.5","title":"Artifact completion: two-phase commit protocol","description":"Implement the two-phase commit protocol for artifact writing on the worker. Order: 1) Write all job artifacts to final relative paths (or write-then-rename per file). 2) Write manifest.json enumerating the final set. 3) Write attestation.json binding manifest. 4) Write job_index.json LAST and atomically (write-then-rename). This prevents consumers from observing partially-written artifact sets. Consumers (host CLI, fetchers, tooling) must treat existence of job_index.json as the commit marker. Orphaned job directories (no job_index.json, not actively running) should be cleaned up on startup or submit.","acceptance_criteria":"- Artifacts written in order: all job artifacts → manifest.json → attestation.json → job_index.json (LAST)\n- job_index.json written atomically via write-then-rename\n- Consumers can safely treat missing job_index.json as incomplete artifact set\n- Orphaned job dirs (no job_index.json, not running) detected on startup or submit","notes":"\n## Error handling and recovery\n\n### Crash between phases\n- Phase 1 crash: no manifest, no job_index -\u003e orphaned, cleaned up on startup.\n- Phase 2/3 crash: manifest but no job_index -\u003e still incomplete.\n- Phase 4 crash: if rename succeeded -\u003e complete. If not -\u003e temp orphaned, incomplete.\n\n### Disk full during commit\n- Phase 1 artifacts written but commit marker missing -\u003e treated as incomplete.\n- SHOULD check disk space before commit phase, warn if \u003c100MB.\n- If job_index.json write fails: return error to host RPC so host knows to retry/fail.\n\n### Orphan detection\n- Orphan = dir with artifacts, no job_index.json, not actively running.\n- On startup: scan, check active process list, delete orphans.\n- Log each cleanup at WARN with job_id and directory size.","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:36.423156419Z","created_by":"root","updated_at":"2026-02-11T07:48:16.032912861Z","dependencies":[{"issue_id":"rch-mac-y6s.5","depends_on_id":"rch-mac-y6s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-y6s.5","depends_on_id":"rch-mac-y6s.4","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-y6s.6","title":"Schema versioning and compatibility rules","description":"Ensure all JSON artifacts include: schema_version, schema_id, created_at. Run-scoped: also run_id. Job-scoped: also run_id, job_id, job_key. Schema IDs use format like rch-xcode/job@1. Compatibility rules: adding optional fields is backward-compatible (no version bump), removing/changing fields requires bump. Unknown version handling: if schema_id major matches, parse known fields and ignore unknown (forward-compatible). If major differs, reject with diagnostic naming expected vs actual.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-10T22:21:37.271244035Z","created_by":"root","updated_at":"2026-02-10T22:21:37.271244035Z","dependencies":[{"issue_id":"rch-mac-y6s.6","depends_on_id":"rch-mac-y6s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
{"id":"rch-mac-y6s.7","title":"M4 tests: artifact integrity and attestation","description":"Tests for M4 artifact integrity, manifest, attestation, and two-phase commit.\n\n**Manifest tests:**\n\n1. **manifest.json generation:**\n   - Given a known set of job artifacts (summary.json, build.log, toolchain.json, etc.)\n   - Verify: `entries[]` sorted lexicographically by `path`\n   - Verify: each file entry has correct `sha256` (computed over file bytes) and `size`\n   - Verify: directory entries have `sha256=null` and `size=0` and `type=\"directory\"`\n   - Verify: `artifact_root_sha256` = sha256_hex(JCS(entries))\n   - Verify: entries include every file/dir EXCEPT manifest.json, attestation.json, job_index.json\n   - Pass: all checksums match, all entries present, no missing/extra\n\n2. **Host manifest verification — sha256 mismatch:**\n   - Tamper with one file after manifest creation (flip a byte in build.log)\n   - Expected: host detects sha256 mismatch, fails with `failure_kind=ARTIFACTS`, `failure_subkind=INTEGRITY_MISMATCH`\n   - Verify: `integrity_errors[]` in summary.json lists the mismatched path and expected vs actual sha256\n   - Pass: detection, correct error fields, artifacts NOT cached\n\n3. **Host manifest verification — size mismatch:**\n   - Truncate a file after manifest creation\n   - Expected: same detection as sha256 mismatch (size also mismatches)\n   - Pass: integrity_errors mentions size mismatch\n\n4. **Host manifest verification — extra files:**\n   - Add an unexpected file to artifact directory (not in manifest, not in excluded triple)\n   - Expected: host detects extra file, fails with INTEGRITY_MISMATCH\n   - Pass: error mentions the extra file path\n\n5. **Host manifest verification — missing files:**\n   - Delete a file listed in manifest\n   - Expected: host detects missing file, fails with INTEGRITY_MISMATCH\n   - Pass: error mentions the missing file path\n\n6. **artifact_root_sha256 tampering:**\n   - Modify artifact_root_sha256 in manifest.json without changing entries\n   - Expected: host recomputes from entries, detects mismatch\n   - Pass: verification fails\n\n**Attestation tests:**\n\n7. **attestation.json content:**\n   - Verify: contains `job_id`, `job_key`, `source_sha256`, worker identity (name + fingerprint), capabilities.json digest, backend identity, `manifest_sha256`\n   - Verify: `manifest_sha256` = sha256 of manifest.json bytes\n   - Pass: all fields present and correct\n\n8. **Attestation binding:**\n   - Modify manifest.json after attestation created → `manifest_sha256` no longer matches\n   - Expected: host detects attestation-manifest binding broken\n   - Pass: verification fails with `failure_kind=ATTESTATION`\n\n**Two-phase commit tests:**\n\n9. **Write order:**\n   - Instrument mock worker to record write order of files\n   - Expected order: all artifacts → manifest.json → attestation.json → job_index.json (last)\n   - Pass: job_index.json is strictly last\n\n10. **Partial artifacts (no job_index.json) = incomplete:**\n    - Create artifact directory with summary.json, build.log, manifest.json but NO job_index.json\n    - Expected: consumers treat as incomplete, worker cleans up on next submit of same job_id\n    - Pass: host does NOT treat as complete, re-fetches/re-submits\n\n11. **Atomic writes:**\n    - Verify all artifact files written via write-then-rename (not direct write)\n    - Pass: no partially-written files observable (test with concurrent reader)\n\n**Artifact index tests:**\n\n12. **job_index.json pointers:**\n    - Verify all relative path pointers resolve to actual files: job.json, job_state.json, summary.json, manifest.json, attestation.json, toolchain.json, destination.json, effective_config.json, invocation.json, job_key_inputs.json, build.log\n    - Verify optional pointers present when artifacts exist: metrics.json, executor_env.json, events.jsonl, result.xcresult/\n    - Verify `artifact_profile` field recorded\n    - Pass: all pointers resolve, no broken references\n\n13. **run_index.json pointers:**\n    - Verify pointers to: run_plan.json, run_state.json, run_summary.json, source_manifest.json, worker_selection.json, capabilities.json\n    - Verify ordered step list with `{index, action, job_id, job_index_path}`\n    - Pass: all pointers resolve\n\n**Schema versioning tests:**\n\n14. **Forward compatibility:**\n    - Parse artifact with `schema_version: 2` but `schema_id: \"rch-xcode/summary@1\"` (same major)\n    - Expected: parse known fields, ignore unknown fields\n    - Pass: no error, known fields accessible\n\n15. **Major version mismatch:**\n    - Parse artifact with `schema_id: \"rch-xcode/summary@2\"` (different major)\n    - Expected: reject with diagnostic naming expected vs actual schema_id\n    - Pass: clear rejection message\n\n**Pass/fail:** Each test uses fixture artifact directories with known content. sha256 golden values pre-computed. Tests run without live worker.\n\n**Logging:** Host MUST log at INFO: manifest verification started/passed/failed. At DEBUG: per-file verification results. At ERROR: integrity mismatches with file paths and digests. Tests verify log contains verification result.\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-02-10T22:21:38.030298297Z","created_by":"root","updated_at":"2026-02-11T07:20:03.423920359Z","dependencies":[{"issue_id":"rch-mac-y6s.7","depends_on_id":"rch-mac-y6s","type":"parent-child","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-y6s.7","depends_on_id":"rch-mac-y6s.2","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"},{"issue_id":"rch-mac-y6s.7","depends_on_id":"rch-mac-y6s.5","type":"blocks","created_at":"2026-02-11T15:29:40Z","created_by":"import"}]}
